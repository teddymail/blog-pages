{"title":"saltStack 搭建","date":"2018-07-30T02:52:30.000Z","source":"_posts/2018-07-30.saltStack_搭建.md","raw":"---\ntitle: saltStack 搭建\ndate: 2018-07-30 10:52:30\ntags: ['saltStack','运维']\n---\n\n>SaltStack是一个服务器基础架构集中化管理平台，具备配置管理、远程执行、监控等功能，一般可以理解为简化版的puppet和加强版的func。SaltStack基于Python语言实现，结合轻量级消息队列（ZeroMQ）与Python第三方模块（Pyzmq、PyCrypto、Pyjinjia2、python-msgpack和PyYAML等）构建。\n通过部署SaltStack环境，我们可以在成千上万台服务器上做到批量执行命令，根据不同业务特性进行配置集中化管理、分发文件、采集服务器数据、操作系统基础及软件包管理等，SaltStack是运维人员提高工作效率、规范业务配置与操作的利器。\n\n![\b](http://img.yuekang.org.cn/2018073001.png)\n\n组成形式\n![](http://img.yuekang.org.cn/2018073101.png)\n\n配置文件从top.sls为入口，这里面定义所有文件信息。\n\n# 基础环境搭建\n\n### 服务端安装脚本\n\n```shell\ncurl -L https://bootstrap.saltstack.com -o install_salt.sh\nsudo sh install_salt.sh -P -M\n```\n\n### 客户端安装脚本\n\n```shell\ncurl -L https://bootstrap.saltstack.com -o install_salt.sh\nsudo sh install_salt.sh -P\n```\n\n\b 指定`-P`  代表着 master 安装\n\n# 基础环境配置\n\n### 服务端\n\n```yaml\nvi /etc/salt/master\n\n//配置主服务器地址\ninterface: 192.168.1.192\n\n//以哪个用户运行\nuser: root\n\n//指定salt配置路径\nfile_roots:\n  base:\n    - /root/saltstack/salt/base\n  prod:\n    - /root/saltstack/salt/prod\n\n//环境配置文件\npillar_roots:\n  base:\n    - /root/saltstack/pillar/base\n\n```\n\n### 客户端配置\n\n```yaml\nvi /etc/salt/minion\n\n//指定主服务器ip\nmaster: 192.168.1.192\n\n//指定机器ID 不要重名！ \nid: salt_slave_01\n\n```\n此刻就配置完毕，进入调试连接部分\n\n```yaml\n//打开客户端的debug模式(注意，必须关闭salt-minion服务，否则会提示端口占用，debug模式单独跑的！调试完毕以后在启动salt-minion服务)\n\nroot@salt_slave_01:~# salt-minion -l debug\n\n//进入master，查看授权列表\n[root@localhost ~]# salt-key -L\nAccepted Keys:  //同意的key\nDenied Keys:    //拒绝的key\nUnaccepted Keys: //未接受的key\nsalt_slave_01\nsalt_slave_02\nRejected Keys: //被拒绝的key\n\n//可以看到已经\b有两个minion请求\b授权了\n//授权主机\n[root@localhost ~]# salt-key -a salt_slave1\n\n//全部授权\n[root@localhost ~]# salt-key -A\n\n//授权结束以后就完成了master和minion的连接动作\n\n//测试和子节点的连通性\n[root@localhost ~]# salt '*' test.ping\nsalt_slave_01:\n    True\nsalt_slave_02:\n    True\n\n//安装配置文件中的服务，并同步所有配置文件数据\nsalt '*' sate.highstate\n``\n至此完成全部salt软件安装服务\n\n# 命令附录\n\n```shell\n***********模块***********\n查看模块列表module\nsalt 'minion' sys.list_modules\n查看指定module的function用法\nsalt 'minion' sys.list_functions file\n查看指定模块的详细用法\nsalt 'minion' sys.doc cmd\n\n***********模块使用说明***********\n查看配置管理state模块列表\nsalt 'minion' sys.list_state_modules\n查看配置管理sate列表指定模块所有方法列表\nsalt 'minion' sys.list_state_functions svn\n查看配置管理state列表指定模块详细用法\nsalt 'minion' sys.state_doc file\n查看配置管理state列表指定模块的方法分支\nsalt 'minion' sys.state_doc file.managed\n\n***********pillar变量***********\n查看主机对应的所有pillar变量值\nsalt '*' pillar.data\nsalt '*' pillar.items\n查看主机对应的多个pillar变量值\nsalt '*' pillar.item roles appname\n修改pillar值后需要刷新pillar数据\nsalt '*' saltutil.refresh_pillar\n查看pillar模块详细用法,其他类似\nsalt 'minion' sys.doc pillar\n查看pillar的相关方法\nsalt 'minion' sys.list_functions pillar\n\"\"\"\nshuke:\n    - pillar.data\n    - pillar.ext\n    - pillar.get\n    - pillar.item\n    - pillar.items\n    - pillar.raw\n\"\"\"\n\n***********grains变量***********\n查看模块用法\nsalt 'minion' sys.list_functions grains\n查看item项\nsalt 'minion' grains.ls\n查看所有iteams\nsalt 'minion' grains.items\n获得某个item值\nsalt 'minion' grains.get os\n同步_grains目录下的py脚本至minion\nsalt 'minion' saltutil.sync_all\n如果py模块有修改,修改后进行重载\nsalt 'minion' sys.reload_modules\n\n***********minions在线状态***********\n查看所有minion状态\nsalt-run manage.status\n查看所有minion在线状态\nsalt-run manage.up\n查看所有minion不在线状态\nsalt-run manage.down\n\n***********key管理***********\nsalt-key 密钥管理，通常在master端执行\nsalt-key [options]\nsalt-key -L              ##查看所有minion-key\nsalt-key -a <key-name>   ##接受某个minion-key\nsalt-key -d <key-name>   ##删除某个minion-key\nsalt-key -A              ##接受所有的minion-key\nsalt-key -D              ##删除所有的minion-key\n\n***********salt-call相关***********\nsalt-call 该命令通常在minion上执行，minion自己执行可执行模块，不是通过master下发job\nsalt-call [options] <function> [arguments]\nsalt-call test.ping           \t\t\t##自己执行test.ping命令\nsalt-call cmd.run 'ifconfig'  \t\t\t##自己执行cmd.run函数\n\n***********文件分发***********\nsalt-cp 分发文件到minion上,不支持目录分发，通常在master运行\nsalt-cp [options] '<target>' SOURCE DEST\nsalt-cp '*' testfile.html /tmp\nsalt-cp 'test*' index.html /tmp/a.html\nsalt 'S1_0_001_Room' cp.get_dir salt://package /tmp -v  同步目录\nsalt 'S1_0_001_Room' cp.get_file salt://package/minions.tar.gz /tmp/minions.tar.gz gzip=5    同步文件\n\n**********其他***********\nsalt-run jobs.active            #查看所有minion当前正在运行的jobs\nsalt '*' saltutil.running       # 查看正在运行的任务，找到jid\nsalt '*' saltutil.kill_job jid  # 根据jid杀掉任务\nsalt '*' saltutil.clear_cache   # 清除minion缓存\n\n执行单个命令\nsalt 'minion' cmd.run 'ps -ef | grep mongod'\n\n测试单个sls模块\nsalt 'minion' state.sls nginx test=True\n\n执行前进行测试\nsalt 'minion' state.highstate test=True\n\n在所有minion上执行状态:\nsalt 'minion' sate.highstate\n\n获取执行jib任务的md5值\nsalt 'minion' hashutil.md5_digest 20170202150211366486\n\nlow数据可以使用state.show_lowstate方法查看\nsalt 'minion' state.show_lowstate --out yaml\n\nHigh State数据可以使用state.show_hoghstate方法查看\nsalt 'minion' state.show_highstate --out yaml\n\n#查看highstate\nsalt 'minion' state.show_highstate\n#查看lowdata\nsalt 'minion' state.show_lowstate\n\n#执行所有top.sls\nsalt '*' state.apply\n\n#执行指定环境下top.sls\nsalt '*' state.apply saltenv=dev\n\n注:\nname：要执行的命令，记住该命令将会在salt-minion的路径和权限下执行\nonlyif：用于检查的命令，仅当``onlyif``选项指向的命令返回true时才执行name定义的命令\nunless：用于检查的命令，仅当``unless``选项指向的命令返回false时才执行name指向的命令\n\n查看wyd用户下进程\nsalt -N 'Z1_S2' cmd.run 'su -c \"ps -u wyd | grep -v top | grep -v bash | grep -v sshd | grep -v grep | grep -v ps | grep -v CMD \" wyd'\n\nstate中(钩子函数)\nrequisiterequisite:require/watch/onchanges/onfail/use/prereq/require_in(反转)\n\n========Targeting Minion=======\n#Glob(默认)\nsalt '*' test.ping\nsalt \\* test.ping\n\n#PCRE 正则表达式\nsalt -E '^[m|M]in.[e|o|u]n$' test.ping = salt -E '^[mM]in.[eou]n$' test.ping\n\n#list\nsalt -L web1,web2,db1 test.ping\n\n#Subnet\nsalt -S 192.168.1.100 test.ping\nsalt -S 192.168.0.0/16 test.ping\n\n#Grain\nsalt -G 'os:ubuntu' test.ping\nsalt -G 'os_family:Debian' test.ping\nsalt -G 'ip_interfaces:eth0:192.168.1.100' test.ping\nsalt -G 'ipv6:::1' test.ping\nsalt --grain-pcre 'os:red(hat|flag)' test.ping\n\n#Pillar\nsalt -I 'my_var:my_val' test.ping\n\n#混合(Compound)\nsalt -C 'G@os:Ubuntu,I@role:web,S@192.168.1.100/24' test.ping\nsalt -C 'min* or *ion' test.ping\nsalt -C 'web* or *qa,G@os:Arch' test.ping\n\n#Nodegroup\nsalt -N　webdev test.ping\n\n添加计划任务\nsalt 'S1_*_Center' cron.set_job root   '0' '5' '*' '*' '*'  '/usr/sbin/logrotate -vf /etc/logrotate.d/acl >/tmp/cutacl_log 2>&1' identifier=cutacl\n\n删除计划任务\nsalt -C 'E@S1_(10001|10002|10003)_*' cron.rm_job wyd 'cd /data/wyd/game_server_1.2.0/log;find . -type f -mtime +15 -name \"*.log*\" -exec rm -rf {} \\; 2>&1' identifier='clear log'\n```\n\n\n\n\n\n\n\n","slug":"2018-07-30-saltStack-搭建","published":true,"updated":"2024-09-02T09:06:11.428Z","_id":"cm0ow91p9001y7jsn07kj6nip","comments":true,"layout":"post","photos":[],"html":"<blockquote>\n<p>SaltStack是一个服务器基础架构集中化管理平台，具备配置管理、远程执行、监控等功能，一般可以理解为简化版的puppet和加强版的func。SaltStack基于Python语言实现，结合轻量级消息队列（ZeroMQ）与Python第三方模块（Pyzmq、PyCrypto、Pyjinjia2、python-msgpack和PyYAML等）构建。<br>通过部署SaltStack环境，我们可以在成千上万台服务器上做到批量执行命令，根据不同业务特性进行配置集中化管理、分发文件、采集服务器数据、操作系统基础及软件包管理等，SaltStack是运维人员提高工作效率、规范业务配置与操作的利器。</p>\n</blockquote>\n<p><img src=\"http://img.yuekang.org.cn/2018073001.png\" alt=\"\b\"></p>\n<p>组成形式<br><img src=\"http://img.yuekang.org.cn/2018073101.png\"></p>\n<p>配置文件从top.sls为入口，这里面定义所有文件信息。</p>\n<h1 id=\"基础环境搭建\"><a href=\"#基础环境搭建\" class=\"headerlink\" title=\"基础环境搭建\"></a>基础环境搭建</h1><h3 id=\"服务端安装脚本\"><a href=\"#服务端安装脚本\" class=\"headerlink\" title=\"服务端安装脚本\"></a>服务端安装脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class=\"line\">sudo sh install_salt.sh -P -M</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"客户端安装脚本\"><a href=\"#客户端安装脚本\" class=\"headerlink\" title=\"客户端安装脚本\"></a>客户端安装脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class=\"line\">sudo sh install_salt.sh -P</span><br></pre></td></tr></table></figure>\n\n<p>\b 指定<code>-P</code>  代表着 master 安装</p>\n<h1 id=\"基础环境配置\"><a href=\"#基础环境配置\" class=\"headerlink\" title=\"基础环境配置\"></a>基础环境配置</h1><h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vi</span> <span class=\"string\">/etc/salt/master</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//配置主服务器地址</span></span><br><span class=\"line\"><span class=\"attr\">interface:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//以哪个用户运行</span></span><br><span class=\"line\"><span class=\"attr\">user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定salt配置路径</span></span><br><span class=\"line\"><span class=\"attr\">file_roots:</span></span><br><span class=\"line\">  <span class=\"attr\">base:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/salt/base</span></span><br><span class=\"line\">  <span class=\"attr\">prod:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/salt/prod</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//环境配置文件</span></span><br><span class=\"line\"><span class=\"attr\">pillar_roots:</span></span><br><span class=\"line\">  <span class=\"attr\">base:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/pillar/base</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"客户端配置\"><a href=\"#客户端配置\" class=\"headerlink\" title=\"客户端配置\"></a>客户端配置</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vi</span> <span class=\"string\">/etc/salt/minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定主服务器ip</span></span><br><span class=\"line\"><span class=\"attr\">master:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定机器ID</span> <span class=\"string\">不要重名！</span> </span><br><span class=\"line\"><span class=\"attr\">id:</span> <span class=\"string\">salt_slave_01</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此刻就配置完毕，进入调试连接部分</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//打开客户端的debug模式(注意，必须关闭salt-minion服务，否则会提示端口占用，debug模式单独跑的！调试完毕以后在启动salt-minion服务)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">root@salt_slave_01:~#</span> <span class=\"string\">salt-minion</span> <span class=\"string\">-l</span> <span class=\"string\">debug</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//进入master，查看授权列表</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -L</span></span><br><span class=\"line\"><span class=\"attr\">Accepted Keys:</span>  <span class=\"string\">//同意的key</span></span><br><span class=\"line\"><span class=\"attr\">Denied Keys:</span>    <span class=\"string\">//拒绝的key</span></span><br><span class=\"line\"><span class=\"attr\">Unaccepted Keys:</span> <span class=\"string\">//未接受的key</span></span><br><span class=\"line\"><span class=\"string\">salt_slave_01</span></span><br><span class=\"line\"><span class=\"string\">salt_slave_02</span></span><br><span class=\"line\"><span class=\"attr\">Rejected Keys:</span> <span class=\"string\">//被拒绝的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//可以看到已经\b有两个minion请求\b授权了</span></span><br><span class=\"line\"><span class=\"string\">//授权主机</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -a salt_slave1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//全部授权</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -A</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//授权结束以后就完成了master和minion的连接动作</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//测试和子节点的连通性</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt &#x27;*&#x27; test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt_slave_01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt_slave_02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//安装配置文件中的服务，并同步所有配置文件数据</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">sate.highstate</span></span><br><span class=\"line\"><span class=\"string\">``</span></span><br><span class=\"line\"><span class=\"string\">至此完成全部salt软件安装服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 命令附录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">```shell</span></span><br><span class=\"line\"><span class=\"string\">***********模块***********</span></span><br><span class=\"line\"><span class=\"string\">查看模块列表module</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_modules</span></span><br><span class=\"line\"><span class=\"string\">查看指定module的function用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"string\">查看指定模块的详细用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.doc</span> <span class=\"string\">cmd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********模块使用说明***********</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state模块列表</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_state_modules</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理sate列表指定模块所有方法列表</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_state_functions</span> <span class=\"string\">svn</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state列表指定模块详细用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.state_doc</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state列表指定模块的方法分支</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.state_doc</span> <span class=\"string\">file.managed</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********pillar变量***********</span></span><br><span class=\"line\"><span class=\"string\">查看主机对应的所有pillar变量值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.data</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.items</span></span><br><span class=\"line\"><span class=\"string\">查看主机对应的多个pillar变量值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.item</span> <span class=\"string\">roles</span> <span class=\"string\">appname</span></span><br><span class=\"line\"><span class=\"string\">修改pillar值后需要刷新pillar数据</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.refresh_pillar</span></span><br><span class=\"line\"><span class=\"string\">查看pillar模块详细用法,其他类似</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.doc</span> <span class=\"string\">pillar</span></span><br><span class=\"line\"><span class=\"string\">查看pillar的相关方法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">pillar</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">shuke:</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.data</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.ext</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.get</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.item</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.items</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.raw</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span><span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********grains变量***********</span></span><br><span class=\"line\"><span class=\"string\">查看模块用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">grains</span></span><br><span class=\"line\"><span class=\"string\">查看item项</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.ls</span></span><br><span class=\"line\"><span class=\"string\">查看所有iteams</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.items</span></span><br><span class=\"line\"><span class=\"string\">获得某个item值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.get</span> <span class=\"string\">os</span></span><br><span class=\"line\"><span class=\"string\">同步_grains目录下的py脚本至minion</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">saltutil.sync_all</span></span><br><span class=\"line\"><span class=\"string\">如果py模块有修改,修改后进行重载</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.reload_modules</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********minions在线状态***********</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.status</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion在线状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.up</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion不在线状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.down</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********key管理***********</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">密钥管理，通常在master端执行</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> [<span class=\"string\">options</span>]</span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-L</span>              <span class=\"comment\">##查看所有minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-a</span> <span class=\"string\">&lt;key-name&gt;</span>   <span class=\"comment\">##接受某个minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-d</span> <span class=\"string\">&lt;key-name&gt;</span>   <span class=\"comment\">##删除某个minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-A</span>              <span class=\"comment\">##接受所有的minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-D</span>              <span class=\"comment\">##删除所有的minion-key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********salt-call相关***********</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">该命令通常在minion上执行，minion自己执行可执行模块，不是通过master下发job</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> [<span class=\"string\">options</span>] <span class=\"string\">&lt;function&gt;</span> [<span class=\"string\">arguments</span>]</span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">test.ping</span>           \t\t\t<span class=\"comment\">##自己执行test.ping命令</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;ifconfig&#x27;</span>  \t\t\t<span class=\"comment\">##自己执行cmd.run函数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********文件分发***********</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">分发文件到minion上,不支持目录分发，通常在master运行</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> [<span class=\"string\">options</span>] <span class=\"string\">&#x27;&lt;target&gt;&#x27;</span> <span class=\"string\">SOURCE</span> <span class=\"string\">DEST</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">testfile.html</span> <span class=\"string\">/tmp</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">&#x27;test*&#x27;</span> <span class=\"string\">index.html</span> <span class=\"string\">/tmp/a.html</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_0_001_Room&#x27;</span> <span class=\"string\">cp.get_dir</span> <span class=\"string\">salt://package</span> <span class=\"string\">/tmp</span> <span class=\"string\">-v</span>  <span class=\"string\">同步目录</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_0_001_Room&#x27;</span> <span class=\"string\">cp.get_file</span> <span class=\"string\">salt://package/minions.tar.gz</span> <span class=\"string\">/tmp/minions.tar.gz</span> <span class=\"string\">gzip=5</span>    <span class=\"string\">同步文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">**********其他***********</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">jobs.active</span>            <span class=\"comment\">#查看所有minion当前正在运行的jobs</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.running</span>       <span class=\"comment\"># 查看正在运行的任务，找到jid</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.kill_job</span> <span class=\"string\">jid</span>  <span class=\"comment\"># 根据jid杀掉任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.clear_cache</span>   <span class=\"comment\"># 清除minion缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">执行单个命令</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;ps -ef | grep mongod&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">测试单个sls模块</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.sls</span> <span class=\"string\">nginx</span> <span class=\"string\">test=True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">执行前进行测试</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.highstate</span> <span class=\"string\">test=True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在所有minion上执行状态:</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sate.highstate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">获取执行jib任务的md5值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">hashutil.md5_digest</span> <span class=\"number\">20170202150211366486</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">low数据可以使用state.show_lowstate方法查看</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_lowstate</span> <span class=\"string\">--out</span> <span class=\"string\">yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">High</span> <span class=\"string\">State数据可以使用state.show_hoghstate方法查看</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_highstate</span> <span class=\"string\">--out</span> <span class=\"string\">yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看highstate</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_highstate</span></span><br><span class=\"line\"><span class=\"comment\">#查看lowdata</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_lowstate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行所有top.sls</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">state.apply</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行指定环境下top.sls</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">state.apply</span> <span class=\"string\">saltenv=dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">注:</span></span><br><span class=\"line\"><span class=\"string\">name：要执行的命令，记住该命令将会在salt-minion的路径和权限下执行</span></span><br><span class=\"line\"><span class=\"string\">onlyif：用于检查的命令，仅当``onlyif``选项指向的命令返回true时才执行name定义的命令</span></span><br><span class=\"line\"><span class=\"string\">unless：用于检查的命令，仅当``unless``选项指向的命令返回false时才执行name指向的命令</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">查看wyd用户下进程</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-N</span> <span class=\"string\">&#x27;Z1_S2&#x27;</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;su -c &quot;ps -u wyd | grep -v top | grep -v bash | grep -v sshd | grep -v grep | grep -v ps | grep -v CMD &quot; wyd&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">state中(钩子函数)</span></span><br><span class=\"line\"><span class=\"string\">requisiterequisite:require/watch/onchanges/onfail/use/prereq/require_in(反转)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">========Targeting</span> <span class=\"string\">Minion=======</span></span><br><span class=\"line\"><span class=\"comment\">#Glob(默认)</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">\\*</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#PCRE 正则表达式</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-E</span> <span class=\"string\">&#x27;^[m|M]in.[e|o|u]n$&#x27;</span> <span class=\"string\">test.ping</span> <span class=\"string\">=</span> <span class=\"string\">salt</span> <span class=\"string\">-E</span> <span class=\"string\">&#x27;^[mM]in.[eou]n$&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#list</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-L</span> <span class=\"string\">web1,web2,db1</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Subnet</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-S</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-S</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Grain</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;os:ubuntu&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;os_family:Debian&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;ip_interfaces:eth0:192.168.1.100&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;ipv6:::1&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">--grain-pcre</span> <span class=\"string\">&#x27;os:red(hat|flag)&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Pillar</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-I</span> <span class=\"string\">&#x27;my_var:my_val&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#混合(Compound)</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;G@os:Ubuntu,I@role:web,S@192.168.1.100/24&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;min* or *ion&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;web* or *qa,G@os:Arch&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Nodegroup</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-N</span>　<span class=\"string\">webdev</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">添加计划任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_*_Center&#x27;</span> <span class=\"string\">cron.set_job</span> <span class=\"string\">root</span>   <span class=\"string\">&#x27;0&#x27;</span> <span class=\"string\">&#x27;5&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span>  <span class=\"string\">&#x27;/usr/sbin/logrotate -vf /etc/logrotate.d/acl &gt;/tmp/cutacl_log 2&gt;&amp;1&#x27;</span> <span class=\"string\">identifier=cutacl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">删除计划任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;E@S1_(10001|10002|10003)_*&#x27;</span> <span class=\"string\">cron.rm_job</span> <span class=\"string\">wyd</span> <span class=\"string\">&#x27;cd /data/wyd/game_server_1.2.0/log;find . -type f -mtime +15 -name &quot;*.log*&quot; -exec rm -rf &#123;&#125; \\; 2&gt;&amp;1&#x27;</span> <span class=\"string\">identifier=&#x27;clear</span> <span class=\"string\">log&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n","excerpt":"","more":"<blockquote>\n<p>SaltStack是一个服务器基础架构集中化管理平台，具备配置管理、远程执行、监控等功能，一般可以理解为简化版的puppet和加强版的func。SaltStack基于Python语言实现，结合轻量级消息队列（ZeroMQ）与Python第三方模块（Pyzmq、PyCrypto、Pyjinjia2、python-msgpack和PyYAML等）构建。<br>通过部署SaltStack环境，我们可以在成千上万台服务器上做到批量执行命令，根据不同业务特性进行配置集中化管理、分发文件、采集服务器数据、操作系统基础及软件包管理等，SaltStack是运维人员提高工作效率、规范业务配置与操作的利器。</p>\n</blockquote>\n<p><img src=\"http://img.yuekang.org.cn/2018073001.png\" alt=\"\b\"></p>\n<p>组成形式<br><img src=\"http://img.yuekang.org.cn/2018073101.png\"></p>\n<p>配置文件从top.sls为入口，这里面定义所有文件信息。</p>\n<h1 id=\"基础环境搭建\"><a href=\"#基础环境搭建\" class=\"headerlink\" title=\"基础环境搭建\"></a>基础环境搭建</h1><h3 id=\"服务端安装脚本\"><a href=\"#服务端安装脚本\" class=\"headerlink\" title=\"服务端安装脚本\"></a>服务端安装脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class=\"line\">sudo sh install_salt.sh -P -M</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"客户端安装脚本\"><a href=\"#客户端安装脚本\" class=\"headerlink\" title=\"客户端安装脚本\"></a>客户端安装脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class=\"line\">sudo sh install_salt.sh -P</span><br></pre></td></tr></table></figure>\n\n<p>\b 指定<code>-P</code>  代表着 master 安装</p>\n<h1 id=\"基础环境配置\"><a href=\"#基础环境配置\" class=\"headerlink\" title=\"基础环境配置\"></a>基础环境配置</h1><h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vi</span> <span class=\"string\">/etc/salt/master</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//配置主服务器地址</span></span><br><span class=\"line\"><span class=\"attr\">interface:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//以哪个用户运行</span></span><br><span class=\"line\"><span class=\"attr\">user:</span> <span class=\"string\">root</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定salt配置路径</span></span><br><span class=\"line\"><span class=\"attr\">file_roots:</span></span><br><span class=\"line\">  <span class=\"attr\">base:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/salt/base</span></span><br><span class=\"line\">  <span class=\"attr\">prod:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/salt/prod</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//环境配置文件</span></span><br><span class=\"line\"><span class=\"attr\">pillar_roots:</span></span><br><span class=\"line\">  <span class=\"attr\">base:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/root/saltstack/pillar/base</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"客户端配置\"><a href=\"#客户端配置\" class=\"headerlink\" title=\"客户端配置\"></a>客户端配置</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vi</span> <span class=\"string\">/etc/salt/minion</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定主服务器ip</span></span><br><span class=\"line\"><span class=\"attr\">master:</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.192</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//指定机器ID</span> <span class=\"string\">不要重名！</span> </span><br><span class=\"line\"><span class=\"attr\">id:</span> <span class=\"string\">salt_slave_01</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>此刻就配置完毕，进入调试连接部分</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//打开客户端的debug模式(注意，必须关闭salt-minion服务，否则会提示端口占用，debug模式单独跑的！调试完毕以后在启动salt-minion服务)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">root@salt_slave_01:~#</span> <span class=\"string\">salt-minion</span> <span class=\"string\">-l</span> <span class=\"string\">debug</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//进入master，查看授权列表</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -L</span></span><br><span class=\"line\"><span class=\"attr\">Accepted Keys:</span>  <span class=\"string\">//同意的key</span></span><br><span class=\"line\"><span class=\"attr\">Denied Keys:</span>    <span class=\"string\">//拒绝的key</span></span><br><span class=\"line\"><span class=\"attr\">Unaccepted Keys:</span> <span class=\"string\">//未接受的key</span></span><br><span class=\"line\"><span class=\"string\">salt_slave_01</span></span><br><span class=\"line\"><span class=\"string\">salt_slave_02</span></span><br><span class=\"line\"><span class=\"attr\">Rejected Keys:</span> <span class=\"string\">//被拒绝的key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//可以看到已经\b有两个minion请求\b授权了</span></span><br><span class=\"line\"><span class=\"string\">//授权主机</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -a salt_slave1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//全部授权</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt-key -A</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//授权结束以后就完成了master和minion的连接动作</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//测试和子节点的连通性</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># salt &#x27;*&#x27; test.ping</span></span><br><span class=\"line\"><span class=\"attr\">salt_slave_01:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"><span class=\"attr\">salt_slave_02:</span></span><br><span class=\"line\">    <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//安装配置文件中的服务，并同步所有配置文件数据</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">sate.highstate</span></span><br><span class=\"line\"><span class=\"string\">``</span></span><br><span class=\"line\"><span class=\"string\">至此完成全部salt软件安装服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 命令附录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">```shell</span></span><br><span class=\"line\"><span class=\"string\">***********模块***********</span></span><br><span class=\"line\"><span class=\"string\">查看模块列表module</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_modules</span></span><br><span class=\"line\"><span class=\"string\">查看指定module的function用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"string\">查看指定模块的详细用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.doc</span> <span class=\"string\">cmd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********模块使用说明***********</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state模块列表</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_state_modules</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理sate列表指定模块所有方法列表</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_state_functions</span> <span class=\"string\">svn</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state列表指定模块详细用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.state_doc</span> <span class=\"string\">file</span></span><br><span class=\"line\"><span class=\"string\">查看配置管理state列表指定模块的方法分支</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.state_doc</span> <span class=\"string\">file.managed</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********pillar变量***********</span></span><br><span class=\"line\"><span class=\"string\">查看主机对应的所有pillar变量值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.data</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.items</span></span><br><span class=\"line\"><span class=\"string\">查看主机对应的多个pillar变量值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">pillar.item</span> <span class=\"string\">roles</span> <span class=\"string\">appname</span></span><br><span class=\"line\"><span class=\"string\">修改pillar值后需要刷新pillar数据</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.refresh_pillar</span></span><br><span class=\"line\"><span class=\"string\">查看pillar模块详细用法,其他类似</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.doc</span> <span class=\"string\">pillar</span></span><br><span class=\"line\"><span class=\"string\">查看pillar的相关方法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">pillar</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">shuke:</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.data</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.ext</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.get</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.item</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.items</span></span><br><span class=\"line\"><span class=\"string\">    - pillar.raw</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span><span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********grains变量***********</span></span><br><span class=\"line\"><span class=\"string\">查看模块用法</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.list_functions</span> <span class=\"string\">grains</span></span><br><span class=\"line\"><span class=\"string\">查看item项</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.ls</span></span><br><span class=\"line\"><span class=\"string\">查看所有iteams</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.items</span></span><br><span class=\"line\"><span class=\"string\">获得某个item值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">grains.get</span> <span class=\"string\">os</span></span><br><span class=\"line\"><span class=\"string\">同步_grains目录下的py脚本至minion</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">saltutil.sync_all</span></span><br><span class=\"line\"><span class=\"string\">如果py模块有修改,修改后进行重载</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sys.reload_modules</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********minions在线状态***********</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.status</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion在线状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.up</span></span><br><span class=\"line\"><span class=\"string\">查看所有minion不在线状态</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">manage.down</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********key管理***********</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">密钥管理，通常在master端执行</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> [<span class=\"string\">options</span>]</span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-L</span>              <span class=\"comment\">##查看所有minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-a</span> <span class=\"string\">&lt;key-name&gt;</span>   <span class=\"comment\">##接受某个minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-d</span> <span class=\"string\">&lt;key-name&gt;</span>   <span class=\"comment\">##删除某个minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-A</span>              <span class=\"comment\">##接受所有的minion-key</span></span><br><span class=\"line\"><span class=\"string\">salt-key</span> <span class=\"string\">-D</span>              <span class=\"comment\">##删除所有的minion-key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********salt-call相关***********</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">该命令通常在minion上执行，minion自己执行可执行模块，不是通过master下发job</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> [<span class=\"string\">options</span>] <span class=\"string\">&lt;function&gt;</span> [<span class=\"string\">arguments</span>]</span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">test.ping</span>           \t\t\t<span class=\"comment\">##自己执行test.ping命令</span></span><br><span class=\"line\"><span class=\"string\">salt-call</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;ifconfig&#x27;</span>  \t\t\t<span class=\"comment\">##自己执行cmd.run函数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">***********文件分发***********</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">分发文件到minion上,不支持目录分发，通常在master运行</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> [<span class=\"string\">options</span>] <span class=\"string\">&#x27;&lt;target&gt;&#x27;</span> <span class=\"string\">SOURCE</span> <span class=\"string\">DEST</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">testfile.html</span> <span class=\"string\">/tmp</span></span><br><span class=\"line\"><span class=\"string\">salt-cp</span> <span class=\"string\">&#x27;test*&#x27;</span> <span class=\"string\">index.html</span> <span class=\"string\">/tmp/a.html</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_0_001_Room&#x27;</span> <span class=\"string\">cp.get_dir</span> <span class=\"string\">salt://package</span> <span class=\"string\">/tmp</span> <span class=\"string\">-v</span>  <span class=\"string\">同步目录</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_0_001_Room&#x27;</span> <span class=\"string\">cp.get_file</span> <span class=\"string\">salt://package/minions.tar.gz</span> <span class=\"string\">/tmp/minions.tar.gz</span> <span class=\"string\">gzip=5</span>    <span class=\"string\">同步文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">**********其他***********</span></span><br><span class=\"line\"><span class=\"string\">salt-run</span> <span class=\"string\">jobs.active</span>            <span class=\"comment\">#查看所有minion当前正在运行的jobs</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.running</span>       <span class=\"comment\"># 查看正在运行的任务，找到jid</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.kill_job</span> <span class=\"string\">jid</span>  <span class=\"comment\"># 根据jid杀掉任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">saltutil.clear_cache</span>   <span class=\"comment\"># 清除minion缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">执行单个命令</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;ps -ef | grep mongod&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">测试单个sls模块</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.sls</span> <span class=\"string\">nginx</span> <span class=\"string\">test=True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">执行前进行测试</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.highstate</span> <span class=\"string\">test=True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在所有minion上执行状态:</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">sate.highstate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">获取执行jib任务的md5值</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">hashutil.md5_digest</span> <span class=\"number\">20170202150211366486</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">low数据可以使用state.show_lowstate方法查看</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_lowstate</span> <span class=\"string\">--out</span> <span class=\"string\">yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">High</span> <span class=\"string\">State数据可以使用state.show_hoghstate方法查看</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_highstate</span> <span class=\"string\">--out</span> <span class=\"string\">yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看highstate</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_highstate</span></span><br><span class=\"line\"><span class=\"comment\">#查看lowdata</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;minion&#x27;</span> <span class=\"string\">state.show_lowstate</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行所有top.sls</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">state.apply</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行指定环境下top.sls</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">state.apply</span> <span class=\"string\">saltenv=dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">注:</span></span><br><span class=\"line\"><span class=\"string\">name：要执行的命令，记住该命令将会在salt-minion的路径和权限下执行</span></span><br><span class=\"line\"><span class=\"string\">onlyif：用于检查的命令，仅当``onlyif``选项指向的命令返回true时才执行name定义的命令</span></span><br><span class=\"line\"><span class=\"string\">unless：用于检查的命令，仅当``unless``选项指向的命令返回false时才执行name指向的命令</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">查看wyd用户下进程</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-N</span> <span class=\"string\">&#x27;Z1_S2&#x27;</span> <span class=\"string\">cmd.run</span> <span class=\"string\">&#x27;su -c &quot;ps -u wyd | grep -v top | grep -v bash | grep -v sshd | grep -v grep | grep -v ps | grep -v CMD &quot; wyd&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">state中(钩子函数)</span></span><br><span class=\"line\"><span class=\"string\">requisiterequisite:require/watch/onchanges/onfail/use/prereq/require_in(反转)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">========Targeting</span> <span class=\"string\">Minion=======</span></span><br><span class=\"line\"><span class=\"comment\">#Glob(默认)</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">\\*</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#PCRE 正则表达式</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-E</span> <span class=\"string\">&#x27;^[m|M]in.[e|o|u]n$&#x27;</span> <span class=\"string\">test.ping</span> <span class=\"string\">=</span> <span class=\"string\">salt</span> <span class=\"string\">-E</span> <span class=\"string\">&#x27;^[mM]in.[eou]n$&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#list</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-L</span> <span class=\"string\">web1,web2,db1</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Subnet</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-S</span> <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-S</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Grain</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;os:ubuntu&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;os_family:Debian&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;ip_interfaces:eth0:192.168.1.100&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-G</span> <span class=\"string\">&#x27;ipv6:::1&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">--grain-pcre</span> <span class=\"string\">&#x27;os:red(hat|flag)&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Pillar</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-I</span> <span class=\"string\">&#x27;my_var:my_val&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#混合(Compound)</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;G@os:Ubuntu,I@role:web,S@192.168.1.100/24&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;min* or *ion&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;web* or *qa,G@os:Arch&#x27;</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Nodegroup</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-N</span>　<span class=\"string\">webdev</span> <span class=\"string\">test.ping</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">添加计划任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">&#x27;S1_*_Center&#x27;</span> <span class=\"string\">cron.set_job</span> <span class=\"string\">root</span>   <span class=\"string\">&#x27;0&#x27;</span> <span class=\"string\">&#x27;5&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span> <span class=\"string\">&#x27;*&#x27;</span>  <span class=\"string\">&#x27;/usr/sbin/logrotate -vf /etc/logrotate.d/acl &gt;/tmp/cutacl_log 2&gt;&amp;1&#x27;</span> <span class=\"string\">identifier=cutacl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">删除计划任务</span></span><br><span class=\"line\"><span class=\"string\">salt</span> <span class=\"string\">-C</span> <span class=\"string\">&#x27;E@S1_(10001|10002|10003)_*&#x27;</span> <span class=\"string\">cron.rm_job</span> <span class=\"string\">wyd</span> <span class=\"string\">&#x27;cd /data/wyd/game_server_1.2.0/log;find . -type f -mtime +15 -name &quot;*.log*&quot; -exec rm -rf &#123;&#125; \\; 2&gt;&amp;1&#x27;</span> <span class=\"string\">identifier=&#x27;clear</span> <span class=\"string\">log&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n","path":"2018/07/30/2018-07-30-saltStack-搭建/","permalink":"https://yuekang.org.cn/2018/07/30/2018-07-30-saltStack-%E6%90%AD%E5%BB%BA/","tags":[{"name":"运维","_id":"cm0ow91py005g7jsn2qmx2yrx","slug":"运维","path":"tags/运维/","permalink":"https://yuekang.org.cn/tags/%E8%BF%90%E7%BB%B4/","length":6},{"name":"saltStack","_id":"cm0ow91py005h7jsn3zv40h3g","slug":"saltStack","path":"tags/saltStack/","permalink":"https://yuekang.org.cn/tags/saltStack/","length":2}],"categories":[],"prev":{"title":"Zend虚拟机学习","date":"2018-08-05T13:17:47.000Z","slug":"2018-08-05-Zend虚拟机学习","published":true,"updated":"2024-09-02T09:06:11.428Z","_id":"cm0ow91ph00237jsn1t3q0e09","layout":"post","photos":[],"excerpt":"","path":"2018/08/05/2018-08-05-Zend虚拟机学习/","permalink":"https://yuekang.org.cn/2018/08/05/2018-08-05-Zend%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%A6%E4%B9%A0/","__post":true},"next":{"title":"jumperServer","date":"2018-07-22T13:57:11.000Z","slug":"2018-07-22-jumperServer","published":true,"updated":"2024-09-02T09:06:11.428Z","_id":"cm0ow91p8001x7jsn3pa4ds84","layout":"post","photos":[],"excerpt":"","path":"2018/07/22/2018-07-22-jumperServer/","permalink":"https://yuekang.org.cn/2018/07/22/2018-07-22-jumperServer/","__post":true},"__post":true}