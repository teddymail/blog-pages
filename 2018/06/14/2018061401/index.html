<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Yue Kang,ykcode@163.com"><title>PHP7-垃圾回收机制 · 少年当自强</title><meta name="description" content="垃圾回收是一种自动的内存管理机制，当一个变量在程序中不再被使用时，应该予以释放，这种内存资源管理称为垃圾回收。其中一种垃圾回收方式是使用引用计数，通过对数据存储的物理空间多附加一个计数器空间，当其他数据与其相关是，计数器加一，反之，相关解除时计数器减一。定期检查各存储对象的计数器，计数器为零的话，则"><meta name="keywords" content="HTML,JAVA,CSS,安卓,Android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">少年当自强</a></h3><div class="description"><p>Write the code. Change the World.</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/teddymail"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/teddymail"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Copyright &copy; Teddy All rights reserved.</span></a><div class="by_farbox"></div><div class="by_farbox"><script src="/js/jquery.js"></script><script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1261418356'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/stat.php%3Fid%3D1261418356%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">Sobre</a></li><li><a href="/archives">Arquivo</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="http://img.yuekang.org.cn/me.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>PHP7-垃圾回收机制</a></h3></div><div class="post-content"><blockquote>
<p>垃圾回收是一种自动的内存管理机制，当一个变量在程序中不再被使用时，应该予以释放，这种内存资源管理称为垃圾回收。其中一种垃圾回收方式是使用引用计数，通过对数据存储的物理空间多附加一个计数器空间，当其他数据与其相关是，计数器加一，反之，相关解除时计数器减一。定期检查各存储对象的计数器，计数器为零的话，则认为该对象已经被抛弃而应将其所占物理空间回收。</p>
</blockquote>
<p>下面是GC的核心数据结构:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_refcounted</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> refcount;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ZEND_ENDIAN_LOHI_3(</span><br><span class="line">                zend_uchar    type,</span><br><span class="line">                zend_uchar    flags,</span><br><span class="line">                <span class="type">uint16_t</span>      gc_info)</span><br><span class="line">        &#125; v;</span><br><span class="line">        <span class="type">uint32_t</span> type_info;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.yuekang.org.cn/2018061401.png" alt="zend_refcounted_h的结构"></p>
<p>zend_refcounted由32位bit的refcount和32bit的type_info组成</p>
<p>1. type 第一个字节记录当前元素的类型</p>
<ol start="2">
<li><p>flags 第二个字节用来记录数据类型</p>
</li>
<li><p>gc_info 后面的两个字节标记当前元素的颜色和垃圾回收池中的位置，其中高地址的两位用来标记颜色。</p>
</li>
</ol>
<p>3.1 颜色有 黑色，白色，灰色，紫色</p>
<p>php性能提升<br><img src="http://img.yuekang.org.cn/2018061404.gif"></p>
<h2 id="gc垃圾收集器"><a href="#gc垃圾收集器" class="headerlink" title="gc垃圾收集器"></a>gc垃圾收集器</h2><p>下面是gc_globals的结构</p>
<p><img src="http://img.yuekang.org.cn/2018061802.png"></p>
<p>gc_root_buffer 是一个双向链表，同时记录引用计数的相关信息，zend_gc_globals维护者gc的整个信息，这里列出个字段的含义。</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">字段</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">gc_enabled</td>
<td align="left">是否开启gc</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">gc_active</td>
<td align="left">垃圾回收算法是否运行</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">gc_full</td>
<td align="left">垃圾缓冲区是否满了，在debug模式下有用</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">buf</td>
<td align="left">垃圾缓冲区，PHP7默认大小为10 000个节点位置，0位置保留</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">roots</td>
<td align="left">指向缓冲区中最新加入的可能是垃圾的元素</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">unused</td>
<td align="left">指向缓冲区中没有使用的位置，在没有启动垃圾回收算法前，指向空</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">first_unused</td>
<td align="left">指向缓冲区中第一个未使用的位置，新的元素插入缓冲区后，指针会后移动一位</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left">last_unused</td>
<td align="left">指向缓冲区中最后一个位置</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left">to_free</td>
<td align="left">待释放的列表</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left">next_to_free</td>
<td align="left">下一个待释放的列表</td>
</tr>
<tr>
<td align="left">11</td>
<td align="left">gc_runs</td>
<td align="left">记录gc算法的运行的次数，当缓冲区满了，才会运行gc算法</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left">collected</td>
<td align="left">记录gc算法回收的垃圾数</td>
</tr>
</tbody></table>
<h2 id="垃圾收集过程"><a href="#垃圾收集过程" class="headerlink" title="垃圾收集过程"></a>垃圾收集过程</h2><ol>
<li>要求数据类型是数组和对象</li>
<li>没有在缓冲区中存在过</li>
<li>没有被标记过</li>
<li>将其gc_info标记为紫色的，且记录其在缓冲区的位置</li>
</ol>
<p>当缓冲区满时，再收集新的元素会出发垃圾回收算法。</p>
<p>垃圾流转图：</p>
<p><img src="http://img.yuekang.org.cn/2018061801.png"></p>
<p>回收过程分为4部分</p>
<ol>
<li><p>对roots环中每一个元素进行深度优先遍历，将每个元素中gc_info为紫色的标记元素为灰色，且引用计数-1</p>
</li>
<li><p>扫描roots换中gc_info为灰色的元素，如果发现引用计数仍旧大于0，说明这个元素在其他地方使用，那么将其颜色重新标记为黑色，如果发现其引用计数是0则将其标记为白色，该过程同样为深度优先遍历。</p>
</li>
<li><p>扫描roots换，将gc_info颜色为黑色的的元素从roots移除，然后对roots中颜色为白色的元素进行深度有限遍历，将其引用计数+1，然后将roots链表移动到待释放列表中（to_free）中等待回收</p>
</li>
</ol>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-06-14</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PHP/" title="PHP">PHP </a><a class="tag" href="/tags/PHP7/" title="PHP7">PHP7 </a><a class="tag" href="/tags/垃圾回收/" title="垃圾回收">垃圾回收 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://yuekang.org.cn/2018/06/14/2018061401/,少年当自强,PHP7-垃圾回收机制,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2018/06/19/2018061901/" title="array常用函数整理">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/06/13/2018061301/" title="PHP7之线程安全">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>