{"title":"Centos 端口转发管理","date":"2018-12-14T02:12:47.000Z","source":"_posts/2018-12-14.Centos_端口转发管理.md","raw":"---\ntitle: Centos 端口转发管理\ndate: 2018-12-14 10:12:47\ntags: [iptables,NAT]\n---\n\n>在工作中经常会遇到vpc网络，内网所有机器通过唯一一台对外的proxy机器进行共享上网，这里记录一下\b如何做好端口转发和管理。\n\n1. 展示所有nat表规则 以编号标注\n\n```\nroot@jumper:~# iptables -L -t nat --line-number\nChain PREROUTING (policy ACCEPT)\nnum  target     prot opt source               destination\n1    DNAT       tcp  --  anywhere             anywhere             tcp dpt:EtherNet/IP-1 to:192.168.1.3:2538\n2    DNAT       tcp  --  anywhere             anywhere             tcp dpt:ssh to:192.168.1.2:2538\n3    DNAT       tcp  --  anywhere             anywhere             tcp dpt:7687 to:192.168.1.3:7687\n4    DNAT       tcp  --  anywhere             anywhere             tcp dpt:dxspider to:192.168.1.3:8873\n\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n\nChain OUTPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n\nChain POSTROUTING (policy ACCEPT)\nnum  target     prot opt source               destination\n1    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp dpt:EtherNet/IP-1 to:192.168.1.1\n2    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:vnwk-prapi to:192.168.1.1\n3    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:ssh to:192.168.1.1\n4    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:7687 to:192.168.1.1\n5    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:dxspider to:192.168.1.1\n6    SNAT       all  --  192.168.1.0/24       anywhere             to:192.168.1.1\n```\n\n2. 删除其中一个规则\n\n```\n// 删除nat表PREROUTING中的第一个规则\niptables -t nat -D PREROUTING 1\n\n// 删除nat表中POSTROUTING中的第一个规则\niptables -t nat -D POSTROUTING 1\n```\n3. 添加转发规则\n\n```\niptables -t nat -A PREROUTING -p tcp -m tcp --dport 2233 -j DNAT --to-destination 192.168.1.2:2538\niptables -t nat -A POSTROUTING -d 192.168.1.2/32 -p tcp -m tcp --dport 2233 -j SNAT --to-source 192.168.1.1\n```\n\n","slug":"2018-12-14-Centos-端口转发管理","published":true,"updated":"2024-09-02T09:06:11.431Z","_id":"cm0ov6iyx002kwjsn3s62dfgr","comments":true,"layout":"post","photos":[],"html":"<blockquote>\n<p>在工作中经常会遇到vpc网络，内网所有机器通过唯一一台对外的proxy机器进行共享上网，这里记录一下\b如何做好端口转发和管理。</p>\n</blockquote>\n<ol>\n<li>展示所有nat表规则 以编号标注</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@jumper:~# iptables -L -t nat --line-number</span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\">1    DNAT       tcp  --  anywhere             anywhere             tcp dpt:EtherNet/IP-1 to:192.168.1.3:2538</span><br><span class=\"line\">2    DNAT       tcp  --  anywhere             anywhere             tcp dpt:ssh to:192.168.1.2:2538</span><br><span class=\"line\">3    DNAT       tcp  --  anywhere             anywhere             tcp dpt:7687 to:192.168.1.3:7687</span><br><span class=\"line\">4    DNAT       tcp  --  anywhere             anywhere             tcp dpt:dxspider to:192.168.1.3:8873</span><br><span class=\"line\"></span><br><span class=\"line\">Chain INPUT (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain POSTROUTING (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\">1    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp dpt:EtherNet/IP-1 to:192.168.1.1</span><br><span class=\"line\">2    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:vnwk-prapi to:192.168.1.1</span><br><span class=\"line\">3    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:ssh to:192.168.1.1</span><br><span class=\"line\">4    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:7687 to:192.168.1.1</span><br><span class=\"line\">5    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:dxspider to:192.168.1.1</span><br><span class=\"line\">6    SNAT       all  --  192.168.1.0/24       anywhere             to:192.168.1.1</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>删除其中一个规则</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 删除nat表PREROUTING中的第一个规则</span><br><span class=\"line\">iptables -t nat -D PREROUTING 1</span><br><span class=\"line\"></span><br><span class=\"line\">// 删除nat表中POSTROUTING中的第一个规则</span><br><span class=\"line\">iptables -t nat -D POSTROUTING 1</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>添加转发规则</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 2233 -j DNAT --to-destination 192.168.1.2:2538</span><br><span class=\"line\">iptables -t nat -A POSTROUTING -d 192.168.1.2/32 -p tcp -m tcp --dport 2233 -j SNAT --to-source 192.168.1.1</span><br></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<blockquote>\n<p>在工作中经常会遇到vpc网络，内网所有机器通过唯一一台对外的proxy机器进行共享上网，这里记录一下\b如何做好端口转发和管理。</p>\n</blockquote>\n<ol>\n<li>展示所有nat表规则 以编号标注</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@jumper:~# iptables -L -t nat --line-number</span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\">1    DNAT       tcp  --  anywhere             anywhere             tcp dpt:EtherNet/IP-1 to:192.168.1.3:2538</span><br><span class=\"line\">2    DNAT       tcp  --  anywhere             anywhere             tcp dpt:ssh to:192.168.1.2:2538</span><br><span class=\"line\">3    DNAT       tcp  --  anywhere             anywhere             tcp dpt:7687 to:192.168.1.3:7687</span><br><span class=\"line\">4    DNAT       tcp  --  anywhere             anywhere             tcp dpt:dxspider to:192.168.1.3:8873</span><br><span class=\"line\"></span><br><span class=\"line\">Chain INPUT (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\"></span><br><span class=\"line\">Chain POSTROUTING (policy ACCEPT)</span><br><span class=\"line\">num  target     prot opt source               destination</span><br><span class=\"line\">1    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp dpt:EtherNet/IP-1 to:192.168.1.1</span><br><span class=\"line\">2    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:vnwk-prapi to:192.168.1.1</span><br><span class=\"line\">3    SNAT       tcp  --  anywhere             dev.my-domain.com     tcp dpt:ssh to:192.168.1.1</span><br><span class=\"line\">4    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:7687 to:192.168.1.1</span><br><span class=\"line\">5    SNAT       tcp  --  anywhere             newdev.my-domain.com  tcp spt:dxspider to:192.168.1.1</span><br><span class=\"line\">6    SNAT       all  --  192.168.1.0/24       anywhere             to:192.168.1.1</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>删除其中一个规则</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 删除nat表PREROUTING中的第一个规则</span><br><span class=\"line\">iptables -t nat -D PREROUTING 1</span><br><span class=\"line\"></span><br><span class=\"line\">// 删除nat表中POSTROUTING中的第一个规则</span><br><span class=\"line\">iptables -t nat -D POSTROUTING 1</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>添加转发规则</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 2233 -j DNAT --to-destination 192.168.1.2:2538</span><br><span class=\"line\">iptables -t nat -A POSTROUTING -d 192.168.1.2/32 -p tcp -m tcp --dport 2233 -j SNAT --to-source 192.168.1.1</span><br></pre></td></tr></table></figure>\n\n","path":"2018/12/14/2018-12-14-Centos-端口转发管理/","permalink":"https://yuekang.org.cn/2018/12/14/2018-12-14-Centos-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E7%AE%A1%E7%90%86/","tags":[{"name":"iptables","_id":"cm0ov6ize006twjsn3ati1xom","slug":"iptables","path":"tags/iptables/","permalink":"https://yuekang.org.cn/tags/iptables/","length":1},{"name":"NAT","_id":"cm0ov6izf006wwjsn8lek1dbo","slug":"NAT","path":"tags/NAT/","permalink":"https://yuekang.org.cn/tags/NAT/","length":1}],"categories":[],"prev":{"title":"RabbitMQ 系统架构和通信过程","date":"2019-01-15T14:55:18.000Z","slug":"2019-01-15-RabbitMQ-系统架构和通信过程","published":true,"updated":"2024-09-02T09:06:11.432Z","_id":"cm0ov6iyy002nwjsn95c13c5o","layout":"post","photos":[],"excerpt":"","path":"2019/01/15/2019-01-15-RabbitMQ-系统架构和通信过程/","permalink":"https://yuekang.org.cn/2019/01/15/2019-01-15-RabbitMQ-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%92%8C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B/","__post":true},"next":{"title":"LDAP 分享","date":"2018-11-28T14:22:42.000Z","slug":"2018-11-28-LDAP-分享","published":true,"updated":"2024-09-02T09:06:11.431Z","_id":"cm0ov6iyx002iwjsnhzoa5ec1","layout":"post","photos":[],"excerpt":"","path":"2018/11/28/2018-11-28-LDAP-分享/","permalink":"https://yuekang.org.cn/2018/11/28/2018-11-28-LDAP-%E5%88%86%E4%BA%AB/","__post":true},"__post":true}