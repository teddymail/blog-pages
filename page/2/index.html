<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Kange"><title>少年当自强</title><meta name="description" content="Write the code. Change the World."><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta id="site_data_static" data-url="/"><meta id="default-theme" data="light"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/theme/light.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&amp;display=swap" rel="stylesheet"><script src="/js_complied/bundle.js"></script><script src="/js/baidu-tongji.js"></script><script>Anatolo.comment.setConfig({"valine":{"enable":true,"appid":"yXrP5LiEu8aLiXNMbcMkjTgk-gzGzoHsz","appkey":"Fb1nRCpsNrMB0U2Fv3jJSCsu","notify":false,"verify":true,"avatar":"","placeholder":"ψ(｀∇´)ψ 快说说你得想法吧！cn.gravatar.com注册专属头像"},"duoshuo":null,"disqus":null,"gentie":null})</script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body> <main-outlet><div class="page-top animated"><div class="nav"><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/tags">Tags</a></li><li><a href="/about">About</a></li><li><a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display: none"> </a></li><li><a class="fa fa-search" onclick="Anatolo.search.openWindow();"></a></li><li><a class="far fa-sun" onclick="Anatolo.darkLightToggle();"></a></li></div><div class="avatar"><img src="http://img.yuekang.org.cn/me.jpg"></div></div></div><div class="sidebar animated"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">少年当自强</a></h3><div class="description"><p>Write the code. Change the World.</p></div></div><ul class="social-links"><li><a href="https://github.com/teddymail"><i class="fab fa-github"></i></a></li><li><a href="mailto:iyuekang@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a href="https://weibo.com/teddymail"><i class="fab fa-weibo"></i></a></li></ul></div></div><div class="footer"><div class="p"><span>Copyright © Teddy All rights reserved. </span><i class="fa fa-star"></i><span>Kange</span></div><div class="by_farbox"><span>Powered by</span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo</a><span>&</span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo</a></div><div class="beian"></div></div></div><div class="main animated fadeInDown"><div class="autopagerize_page_element"><div class="content"><div class="post animated"><div class="post-title"><h3><a href="/2018/11/12/2018-11-12-nginx%E4%B8%8A%E9%83%A8%E7%BD%B2nginx-json-log%E6%9D%A5%E7%9B%91%E6%8E%A7%E7%BD%91%E7%AB%99%E4%B8%8A%E6%8E%A5%E5%8F%A3%E7%9A%84%E8%AF%A6%E7%BB%86%E6%95%B0%E6%8D%AE/">nginx上部署nginx-json-log来监控网站上接口的详细数据</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>业务上有这么一个需求，当接口之间产生的错误仅仅只能靠nginx errlog 来查看，但是具体的交互信息咱们看不到，这里就需要监控Content-Type: application&#x2F;json; 这样的交互数据，以便于后期业务排查错误变得更加的方便。</p>
</blockquote>
<p>开源库：</p>
<ol>
<li>fooinha&#x2F;nginx-json-log</li>
</ol>
<blockquote>
<p>这是一个可以记录输出到多个渠道的nginx模块，支持输出到文件，syslog,kafka这些渠道 地址： <a href="https://github.com/fooinha/nginx-json-log">点我</a></p>
</blockquote>
<p><img src="http://img.yuekang.org.cn/2018111201.png" alt="规划图"></p>
<ol start="2">
<li>jiaz&#x2F;nginx-http-json-log</li>
</ol>
<blockquote>
</blockquote>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-11-12</span><i class="fa fa-tag"></i><a class="tag" href="/tags/nginx/" title="nginx">nginx </a><i class="fa fa-tag"></i><a class="tag" href="/tags/log/" title="log">log </a><span>About 143 words, 28 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/11/06/2018-11-06-php%E5%AE%89%E8%A3%85ZooKeeper/">php安装ZooKeeper</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>上一篇说了zookeeper的搭建，现在就得在php环境中使用上它，<code>&quot;ZooKeeper&quot;</code>是Java开发的对java支持比较好，如果php想使用上必须安装其c扩展才可以使用</p>
</blockquote>
<h2 id="一、基础环境软件包准备"><a href="#一、基础环境软件包准备" class="headerlink" title="一、基础环境软件包准备"></a>一、基础环境软件包准备</h2><ol>
<li>Lib Zookeeper<br>包下载地址： <a href="http://zookeeper.apache.org/releases.html">http://zookeeper.apache.org/releases.html</a></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget  http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>PHP Zookeeper</li>
</ol>
<p>包下载页：<a href="http://pecl.php.net/package/zookeeper">http://pecl.php.net/package/zookeeper</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget http://pecl.php.net/get/zookeeper-0.5.0.tgz</span><br></pre></td></tr></table></figure>


<h3 id="二、-环境安装"><a href="#二、-环境安装" class="headerlink" title="二、 环境安装"></a>二、 环境安装</h3><ol>
<li>libZookeeper安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget  http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</span><br><span class="line">tar zxvf zookeeper-3.4.13.tar.gz</span><br><span class="line">cd zookeeper-3.4.13/src/c</span><br><span class="line">./configure prefix=/usr/local/zookeeper-lib</span><br><span class="line"></span><br><span class="line">//libtool: warning: remember to run &#x27;libtool --finish /usr/local/lib&#x27; </span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>php Zookeeper安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget http://pecl.php.net/get/zookeeper-0.5.0.tgz</span><br><span class="line">tar zxvf zookeeper-0.5.0.tgz</span><br><span class="line">cd zookeeper-0.5.0</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/usr/bin/php-config  --with-libzookeeper-dir=/usr/local/zookeeper-lib/</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、shell安装脚本编写"><a href="#三、shell安装脚本编写" class="headerlink" title="三、shell安装脚本编写"></a>三、shell安装脚本编写</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Author: yuekang &lt;iyuekang AT gmail.com&gt;</span><br><span class="line"># Notes: 此脚本专用用于php安装zookeeper安装</span><br><span class="line"></span><br><span class="line">export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin</span><br><span class="line">clear</span><br><span class="line">printf &quot;</span><br><span class="line">#######################################################################</span><br><span class="line">#            zookeeper Extension Install shell                        #</span><br><span class="line">#                   For online use only                               #</span><br><span class="line">#######################################################################</span><br><span class="line">&quot;</span><br><span class="line"># Check if user is root</span><br><span class="line">[ $(id -u) != &#x27;0&#x27; ] &amp;&amp; &#123; echo &quot;$&#123;CFAILURE&#125;Error: You must be root to run this script$&#123;CEND&#125;&quot;; exit 1; &#125;</span><br><span class="line"></span><br><span class="line">php_install_dir=&quot;/usr/local/php&quot;</span><br><span class="line"></span><br><span class="line"># Check PHP</span><br><span class="line">if [ -e &quot;$&#123;php_install_dir&#125;/bin/phpize&quot; ]; then</span><br><span class="line">  phpExtensionDir=$($&#123;php_install_dir&#125;/bin/php-config --extension-dir)</span><br><span class="line">  PHP_detail_ver=$($&#123;php_install_dir&#125;/bin/php -r &#x27;echo PHP_VERSION;&#x27;)</span><br><span class="line">  PHP_main_ver=$&#123;PHP_detail_ver%.*&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 安装zookeeper Lib库</span><br><span class="line">install_Zookeeper_lib() &#123;</span><br><span class="line">        src_url=&quot;http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz&quot; &amp;&amp; Download_src</span><br><span class="line">        tar zxvf zookeeper-3.4.13.tar.gz</span><br><span class="line">        cd zookeeper-3.4.13/src/c</span><br><span class="line">        ./configure prefix=/usr/local/zookeeper-lib</span><br><span class="line">        make &amp;&amp; make install</span><br><span class="line">        cd</span><br><span class="line">        rm -r zookeeper-3.4.13.tar.gz &amp;&amp; rm -rf zookeeper-3.4.13</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 安装zookeeper扩展</span><br><span class="line">install_Zookeeper_extension() &#123;</span><br><span class="line">        PHP_extension=&quot;zookeeper&quot;</span><br><span class="line">        src_url=&quot;http://pecl.php.net/get/zookeeper-0.5.0.tgz&quot; &amp;&amp; Download_src</span><br><span class="line">        tar zxvf zookeeper-0.5.0.tgz</span><br><span class="line">        cd zookeeper-0.5.0</span><br><span class="line">        $&#123;php_install_dir&#125;/bin/phpize</span><br><span class="line">        ./configure --with-php-config=&quot;$&#123;php_install_dir&#125;/bin/php-config&quot;  --with-libzookeeper-dir=/usr/local/zookeeper-lib/</span><br><span class="line">        make &amp;&amp; make install</span><br><span class="line">        # 加载so组件</span><br><span class="line">        echo &quot;extension=$&#123;PHP_extension&#125;.so&quot; &gt; $&#123;php_install_dir&#125;/etc/php.d/$&#123;PHP_extension&#125;.ini</span><br><span class="line">        cd</span><br><span class="line">        rm -r zookeeper-0.5.0.tgz &amp;&amp; rm -rf zookeeper-0.5.0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Download_src() &#123;</span><br><span class="line">  [ -s &quot;$&#123;src_url##*/&#125;&quot; ] &amp;&amp; echo &quot;[$&#123;CMSG&#125;$&#123;src_url##*/&#125;$&#123;CEND&#125;] found&quot; || &#123; wget --limit-rate=10M -4 --tries=6 -c --no-check-certificate $&#123;src_url&#125;; sleep 1; &#125;</span><br><span class="line">  if [ ! -e &quot;$&#123;src_url##*/&#125;&quot; ]; then</span><br><span class="line">    echo &quot;$&#123;CFAILURE&#125;Auto download failed! You can manually download $&#123;src_url&#125; into the src directory.$&#123;CEND&#125;&quot;</span><br><span class="line">    kill -9 $$ll</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Check succ</span><br><span class="line">Check_succ() &#123;</span><br><span class="line">  [ -f &quot;$&#123;phpExtensionDir&#125;/$&#123;PHP_extension&#125;.so&quot; ] &amp;&amp; &#123; echo;echo &quot;$&#123;CSUCCESS&#125;PHP $&#123;PHP_extension&#125; module installed successfully! $&#123;CEND&#125;&quot;; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_Zookeeper_lib</span><br><span class="line">install_Zookeeper_extension</span><br><span class="line">Check_succ</span><br></pre></td></tr></table></figure>



</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-11-06</span><i class="fa fa-tag"></i><a class="tag" href="/tags/zookeeper/" title="zookeeper">zookeeper </a><i class="fa fa-tag"></i><a class="tag" href="/tags/分布式/" title="分布式">分布式 </a><span>About 578 words, 1 min 55 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/11/05/2018-11-05-ZooKeeper%E9%9B%86%E7%BE%A4%E5%8C%96%E5%AE%89%E8%A3%85/">ZooKeeper集群化安装</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>zookeeper是一个强一致【不严格】的分布式数据库，由多个节点共同组成一个分布式集群，挂掉任意一个节点，数据库仍然可以正常工作，客户端无感知故障切换。客户端向任意一个节点写入数据，其它节点可以立即看到最新的数据。</p>
</blockquote>
<h2 id="布局规划图"><a href="#布局规划图" class="headerlink" title="布局规划图"></a>布局规划图</h2><p><img src="http://img.yuekang.org.cn/2018110565853.png" alt="架构图"></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol>
<li>JRE (依赖的环境)【 <a href="https://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html">点击进入</a> 】</li>
</ol>
<p>安装JRE</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar zxvf jre-8u191-linux-x64.tar.gz</span><br><span class="line">mv jre1.8.0_191/ /opt/</span><br><span class="line">//添加环境变量</span><br><span class="line">vi /etc/profile</span><br><span class="line">//末尾加入</span><br><span class="line">JAVA_HOME=/opt/jre1.8.0_191</span><br><span class="line">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export JAVA_HOME</span><br><span class="line">export PATH</span><br><span class="line">export CLASSPATH</span><br><span class="line">//生效配置</span><br><span class="line">source /etc/profile </span><br></pre></td></tr></table></figure>

<p>开启端口</p>
<blockquote>
<p>默认是2181 我自己设定为2999，2888和3888是机器之间同步端口</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=2999/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=2888/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=3888/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ZooKeeper安装包</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget http://mirror.cogentco.com/pub/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf zookeeper-3.4.13.tar.gz</span><br><span class="line"></span><br><span class="line">mv zookeeper-3.4.13 /opt/</span><br></pre></td></tr></table></figure>
<h2 id="安装配置ZooKeeper"><a href="#安装配置ZooKeeper" class="headerlink" title="安装配置ZooKeeper"></a>安装配置ZooKeeper</h2><blockquote>
<p>基础环境安装完成后，需要配置ZooKeeper</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//配置</span><br><span class="line">cp /opt/zookeeper-3.4.13/conf/zoo_sample.cfg /opt/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">vi /opt/zookeeper-3.4.13/conf/zoo.cfg</span><br></pre></td></tr></table></figure>

<p>有以下配置选项</p>
<ol>
<li>tickTime&#x3D;2000</li>
</ol>
<p>最小时间单元长度，默认3000，例如回话的最小超时时间默认2*tickTIme</p>
<ol start="2">
<li>initLimit&#x3D;5</li>
</ol>
<p>默认：10，定义leader服务在启动过程中等待follower完成数据同步的时间，后续服务器增多需要增大这个值，以保证数据同步顺利完成。</p>
<ol start="3">
<li>dataDir&#x3D;&#x2F;var&#x2F;lib&#x2F;zookeeper&#x2F;</li>
</ol>
<p>无默认，必须配置，用于配置ZooKeeper存放快照文件的目录，如果不配置dataLogDir则也存放在这里面。</p>
<ol start="4">
<li>clientPort&#x3D;2999</li>
</ol>
<p>当前服务对外的端口，集群内服务器都可以配置任意可用端口，不需要保持端口一致！一般是2181， 无默认，必须配置！</p>
<ol start="5">
<li>server.1 &#x3D; server1:2888:3888</li>
</ol>
<p>用于定义整个集群是由那几台机器构成的，每一行代表一个机器配置格式如下：</p>
<p>server.id &#x3D; host:localPort:targetPort</p>
<p>创建myid文件标识当前主机的序号，在dataDir中新建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /var/lib/zookeeper/myid</span><br><span class="line">写上当前主机的序号即可，一定要是整数！</span><br></pre></td></tr></table></figure>


<p>启动ZooKeeper</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/opt/zookeeper-3.4.13/bin/zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper-3.4.13/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure>

<p>看到上方标识意味启动成功</p>
<h2 id="验证ZooKeeper服务"><a href="#验证ZooKeeper服务" class="headerlink" title="验证ZooKeeper服务"></a>验证ZooKeeper服务</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@zookeepermaster bin]# telnet localhost 2999</span><br><span class="line">Trying ::1...</span><br><span class="line">Connected to localhost.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">stat</span><br><span class="line">Zookeeper version: 3.4.13-2d71af4dbe22557fda74f9a9b4309b15a7487f03, built on 06/29/2018 04:05 GMT</span><br><span class="line">Clients:</span><br><span class="line"> /0:0:0:0:0:0:0:1:56564[0](queued=0,recved=1,sent=0)</span><br><span class="line"></span><br><span class="line">Latency min/avg/max: 0/0/0</span><br><span class="line">Received: 1</span><br><span class="line">Sent: 0</span><br><span class="line">Connections: 1</span><br><span class="line">Outstanding: 0</span><br><span class="line">Zxid: 0x200000000</span><br><span class="line">Mode: follower</span><br><span class="line">Node count: 4</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<p>像上方这样的返回意味着已经成功运行ZooKeeper了，其中Mode: follower是当前的身份</p>
<ol>
<li>Mode: leader</li>
</ol>
<p>leader 是节点中选举的主节点整个服务器中就1个</p>
<ol start="2">
<li>Mode: follower</li>
</ol>
<p>follower 是从节点，负责服务客户端</p>
<ol start="3">
<li>Mode: standalone</li>
</ol>
<p>standalone 是单机模式下才会有的</p>
<h2 id="采坑集结"><a href="#采坑集结" class="headerlink" title="采坑集结"></a>采坑集结</h2><p>如果telnet验证时返回下面这样的情况</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@zookeepermaster bin]# telnet 127.0.0.1 2999</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">stat</span><br><span class="line">This ZooKeeper instance is not currently serving requests</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>
<p>碰到上面的情况首先应该检查各个服务节点的机器是否端口已经全部打开？,主要原因就是这个节点无法连接其他服务器造成服务无法选举造成了服务出错</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-11-05</span><i class="fa fa-tag"></i><a class="tag" href="/tags/ZooKeeper/" title="ZooKeeper">ZooKeeper </a><span>About 855 words, 2 min 51 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/10/24/2018-10-24-Centos7%E4%B8%8A%E6%90%AD%E5%BB%BA%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1/">Centos7上搭建统一认证服务</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>一个企业经常会碰上部署多台机器的问题，但是账号管理就成了问题，怎么在N台机器上统一部署账号管理，完成账号统一认证和管理是让我们后续非常方便的地方。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">//安装三大应用，服务端，客户端，导出导入工具</span><br><span class="line">yum install -y openldap-servers openldap-clients migrationtools</span><br><span class="line"></span><br><span class="line">//配置文件</span><br><span class="line">cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line">chown ldap. /var/lib/ldap/DB_CONFIG</span><br><span class="line"></span><br><span class="line">//启动服务</span><br><span class="line">systemctl start slapd</span><br><span class="line">systemctl enable slapd</span><br><span class="line"></span><br><span class="line">//生成root密码</span><br><span class="line">╭─root@ykdev ~</span><br><span class="line">╰─# slappasswd</span><br><span class="line">New password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">&#123;SSHA&#125;/UFZ8EehpMMtKiiAy+vxdxH6fObhaF3l</span><br><span class="line"></span><br><span class="line">//修改rootdn密码</span><br><span class="line">cat chrootpw.ldif</span><br><span class="line">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;/UFZ8EehpMMtKiiAy+vxdxH6fObhaF3l</span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f chrootpw.ldif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//导出基础的Schema，这些 Schema 文件位于 /etc/openldap/schema/ 目录中，定义了我们以后创建的条目可以使用哪些属性</span><br><span class="line">[root@localhost ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif </span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">adding new entry &quot;cn=cosine,cn=schema,cn=config&quot;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif </span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">adding new entry &quot;cn=nis,cn=schema,cn=config&quot;</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif </span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">adding new entry &quot;cn=inetorgperson,cn=schema,cn=config&quot;</span><br><span class="line"></span><br><span class="line">//配置 LDAP 的顶级域</span><br><span class="line">[root@proxy ldap]# cat chdomain.ldif</span><br><span class="line">dn: olcDatabase=&#123;1&#125;monitor,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to * by dn.base=&quot;gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth&quot;</span><br><span class="line">  read by dn.base=&quot;cn=Manager,dc=my-domain,dc=com&quot; read by * none</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcSuffix</span><br><span class="line">olcSuffix: dc=my-domain,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootDN</span><br><span class="line">olcRootDN: cn=Manager,dc=my-domain,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;/UFZ8EehpMMtKiiAy+vxdxH6fObhaF3l</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by</span><br><span class="line">  dn=&quot;cn=Manager,dc=my-domain,dc=com&quot; write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.base=&quot;&quot; by * read</span><br><span class="line">olcAccess: &#123;2&#125;to * by dn=&quot;cn=Manager,dc=my-domain,dc=com&quot; write by * read</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ldapmodify -Y EXTERNAL -H ldapi:/// -f chdomain.ldif </span><br><span class="line"></span><br><span class="line">//导入基础组信息什么的</span><br><span class="line">[root@proxy ldap]# cat base.ldif</span><br><span class="line">dn: dc=my-domain,dc=com</span><br><span class="line">dc: my-domain</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: domain</span><br><span class="line"></span><br><span class="line">dn: ou=People,dc=my-domain,dc=com</span><br><span class="line">ou: People</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">dn: ou=Group,dc=my-domain,dc=com</span><br><span class="line">ou: Group</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">ldapadd -x -D &quot;cn=Manager,dc=my-domain,dc=com&quot; -W -f base.ldif</span><br><span class="line"></span><br><span class="line">//导入用户信息</span><br><span class="line">//修改域名基础信息</span><br><span class="line">vi /usr/share/migrationtools/migrate_common.ph</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">DEFAULT_BASE = <span class="string">&quot;dc=my-domain,dc=com&quot;</span>;</span></span><br><span class="line">[root@proxy ldap]# /usr/share/migrationtools/migrate_passwd.pl /etc/passwd passwd.ldif</span><br><span class="line">[root@proxy ldap]# /usr/share/migrationtools/migrate_group.pl /etc/group group.ldif</span><br><span class="line">[root@proxy ldap]# ldapadd -x -D cn=Manager,dc=my-domain,dc=com -W -f passwd.ldif</span><br><span class="line">[root@proxy ldap]# ldapadd -x -D cn=Manager,dc=my-domain,dc=com -W -f group.ldif</span><br><span class="line"></span><br><span class="line">//查看所有记录</span><br><span class="line">[root@proxy ldap]# ldapsearch -x -b &quot;dc=my-domain,dc=com&quot; -H ldap://192.168.1.1</span><br></pre></td></tr></table></figure>

<p>至此全部搭建完毕</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-10-24</span><i class="fa fa-tag"></i><a class="tag" href="/tags/OpenLdap/" title="OpenLdap">OpenLdap </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Centos/" title="Centos">Centos </a><span>About 665 words, 2 min 13 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/09/29/2018-09-29-KeepAlived%E6%90%AD%E5%BB%BA/">KeepAlived搭建</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>Keepalived是一个用C语言编写的路由软件。该项目的主要目标是为Linux系统和基于Linux的基础架构提供简单而强大的负载均衡和高可用性设施。 负载平衡框架依赖于众所周知且广泛使用的Linux虚拟服务器（IPVS）内核模块，提供Layer4负载均衡。Keepalived实现了一组检查程序，以根据其运行状况动态地和自适应地维护和管理负载均衡的服务器池。另一方面，VRRP实现了高可用性 协议。VRRP是路由器故障转移的基础。此外，Keepalived为VRRP有限状态机实现了一组挂钩，提供低级和高速协议交互。Keepalived框架可以单独使用，也可以一起使用，以提供灵活的基础架构。</p>
</blockquote>
<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><p>KeepAlived官网：<a href="http://www.keepalived.org/">http://www.keepalived.org/</a></p>
<p><img src="http://img.yuekang.org.cn/20180929180628.png" alt="下载位置"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">//下载包</span><br><span class="line">[root@rabbitmq-master ~]# wget http://www.keepalived.org/software/keepalived-2.0.7.tar.gz</span><br><span class="line"></span><br><span class="line">[root@rabbitmq-master ~]# tar -zxvf keepalived-2.0.7.tar.gz</span><br><span class="line">[root@rabbitmq-master ~]# cd keepalived-2.0.7</span><br><span class="line">//统一放到/usr/local/keepalived</span><br><span class="line">[root@rabbitmq-master keepalived-2.0.7]#/configure --prefix=/usr/local/keepalived</span><br><span class="line">[root@rabbitmq-master keepalived-2.0.7]# make &amp;&amp; make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="配置KeepAlive"><a href="#配置KeepAlive" class="headerlink" title="配置KeepAlive"></a>配置KeepAlive</h2><p>配置目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@rabbitmq-master keepalived]# tree etc/</span><br><span class="line">etc/</span><br><span class="line">├── keepalived</span><br><span class="line">│   ├── keepalived.conf</span><br><span class="line">│   └── samples</span><br><span class="line">│       ├── client.pem</span><br><span class="line">│       ├── dh1024.pem</span><br><span class="line">│       ├── keepalived.conf.conditional_conf</span><br><span class="line">│       ├── keepalived.conf.fwmark</span><br><span class="line">│       ├── keepalived.conf.HTTP_GET.port</span><br><span class="line">│       ├── keepalived.conf.inhibit</span><br><span class="line">│       ├── keepalived.conf.IPv6</span><br><span class="line">│       ├── keepalived.conf.misc_check</span><br><span class="line">│       ├── keepalived.conf.misc_check_arg</span><br><span class="line">│       ├── keepalived.conf.quorum</span><br><span class="line">│       ├── keepalived.conf.sample</span><br><span class="line">│       ├── keepalived.conf.SMTP_CHECK</span><br><span class="line">│       ├── keepalived.conf.SSL_GET</span><br><span class="line">│       ├── keepalived.conf.status_code</span><br><span class="line">│       ├── keepalived.conf.track_interface</span><br><span class="line">│       ├── keepalived.conf.virtualhost</span><br><span class="line">│       ├── keepalived.conf.virtual_server_group</span><br><span class="line">│       ├── keepalived.conf.vrrp</span><br><span class="line">│       ├── keepalived.conf.vrrp.localcheck</span><br><span class="line">│       ├── keepalived.conf.vrrp.lvs_syncd</span><br><span class="line">│       ├── keepalived.conf.vrrp.routes</span><br><span class="line">│       ├── keepalived.conf.vrrp.rules</span><br><span class="line">│       ├── keepalived.conf.vrrp.scripts</span><br><span class="line">│       ├── keepalived.conf.vrrp.static_ipaddress</span><br><span class="line">│       ├── keepalived.conf.vrrp.sync</span><br><span class="line">│       ├── root.pem</span><br><span class="line">│       ├── sample.misccheck.smbcheck.sh</span><br><span class="line">│       └── sample_notify_fifo.sh</span><br><span class="line">└── sysconfig</span><br><span class="line">    └── keepalived</span><br><span class="line"></span><br><span class="line">3 directories, 30 files</span><br></pre></td></tr></table></figure>
<p>分别对应系统目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/etc/keepalived/keepalived.conf</span><br><span class="line">/etc/rc.d/init.d/keepalived</span><br><span class="line">/etc/sysconfig/keepalived</span><br></pre></td></tr></table></figure>




<h2 id="可能遇到的错误"><a href="#可能遇到的错误" class="headerlink" title="可能遇到的错误"></a>可能遇到的错误</h2><ol>
<li>缺少编译环境</li>
</ol>
<p><img src="http://img.yuekang.org.cn/20180929181042.png" alt="缺少编译环境的问题"></p>
<p>需要安装编译环境</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@rabbitmq-slave keepalived-2.0.7]# yum install gcc -y</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>缺少openssl组件</li>
</ol>
<p><img src="http://img.yuekang.org.cn/20180929181333.png" alt="缺少openSSL组件"></p>
<p>安装openssl组件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@rabbitmq-slave keepalived-2.0.7]# yum -y install openssl-devel</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>找不到path&#x2F;to&#x2F;keepalived&#x2F;etc&#x2F;rd.d 怎么办?</li>
</ol>
<p>编译的时候缺少安装</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-09-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/KeepAlived/" title="KeepAlived">KeepAlived </a><i class="fa fa-tag"></i><a class="tag" href="/tags/keepalived/" title="keepalived">keepalived </a><i class="fa fa-tag"></i><a class="tag" href="/tags/高可用/" title="高可用">高可用 </a><span>About 648 words, 2 min 9 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/09/25/2018-09-25-HAProxy%E6%90%AD%E5%BB%BA/">HAProxy搭建</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>HAProxy是一个免费的负载均衡软件，可以运行于大部分主流的Linux操作系统上。</p>
</blockquote>
<blockquote>
<p>HAProxy提供了L4(TCP)和L7(HTTP)两种负载均衡能力，具备丰富的功能。HAProxy的社区非常活跃，版本更新快速（最新稳定版1.7.2于2017&#x2F;01&#x2F;13推出）。最关键的是，HAProxy具备媲美商用负载均衡器的性能和稳定性。</p>
</blockquote>
<blockquote>
<p>因为HAProxy的上述优点，它当前不仅仅是免费负载均衡软件的首选，更几乎成为了唯一选择。</p>
</blockquote>
<h2 id="HAProxy的核心功能"><a href="#HAProxy的核心功能" class="headerlink" title="HAProxy的核心功能"></a>HAProxy的核心功能</h2><p>负载均衡：L4和L7两种模式，支持RR&#x2F;静态RR&#x2F;LC&#x2F;IP Hash&#x2F;URI Hash&#x2F;URL_PARAM Hash&#x2F;HTTP_HEADER Hash等丰富的负载均衡算法<br>健康检查：支持TCP和HTTP两种健康检查模式<br>会话保持：对于未实现会话共享的应用集群，可通过Insert Cookie&#x2F;Rewrite Cookie&#x2F;Prefix Cookie，以及上述的多种Hash方式实现会话保持<br>SSL：HAProxy可以解析HTTPS协议，并能够将请求解密为HTTP后向后端传输<br>HTTP请求重写与重定向<br>监控与统计：HAProxy提供了基于Web的统计信息页面，展现健康状态和流量数据。基于此功能，使用者可以开发监控程序来监控HAProxy的状态</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-09-25</span><i class="fa fa-tag"></i><a class="tag" href="/tags/负载均衡/" title="负载均衡">负载均衡 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/HAProxy/" title="HAProxy">HAProxy </a><span>About 372 words, 1 min 14 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/08/09/2018-08-09-SaltStack%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/">SaltStack知识整理</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>上一篇说到了salt的简单安装，接下来将对学习salt相关模块进行整理和学习</p>
</blockquote>
<h1 id="Grains"><a href="#Grains" class="headerlink" title="Grains"></a>Grains</h1><p>Grains是存储minion基本信息的，里面存放了minion端各种系统级参数，采用静态采集方式，在minion启动时进行数据采集。可以通过<br><code>salt &#39;*&#39; saltutil.sync_grains</code> 从新进行minion端静态信息的采集.</p>
<p>展示minion的Grains静态信息 <code>salt &#39;*&#39; grains.items</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">newdev:</span><br><span class="line">    ----------</span><br><span class="line">    SSDs:</span><br><span class="line">        - sda</span><br><span class="line">        - dm-0</span><br><span class="line">        - dm-1</span><br><span class="line">        - dm-2</span><br><span class="line">    biosreleasedate:</span><br><span class="line">        05/21/2018</span><br><span class="line">    biosversion:</span><br><span class="line">        13.3.1 (43365)</span><br><span class="line">    cpu_flags:</span><br><span class="line">        - fpu</span><br><span class="line">        - vme</span><br><span class="line">        - de</span><br><span class="line">        - pse</span><br><span class="line">        - tsc</span><br><span class="line">        - msr</span><br><span class="line">        - pae</span><br><span class="line">        - mce</span><br><span class="line">        - cx8</span><br><span class="line">        - apic</span><br><span class="line">        - sep</span><br><span class="line">        - mtrr</span><br><span class="line">        - pge</span><br><span class="line">        - mca</span><br><span class="line">        - cmov</span><br><span class="line">        - pat</span><br><span class="line">        - pse36</span><br><span class="line">        - clflush</span><br><span class="line">        - mmx</span><br><span class="line">        - fxsr</span><br><span class="line">        - sse</span><br><span class="line">        - sse2</span><br><span class="line">        - ss</span><br><span class="line">        - ht</span><br><span class="line">        - syscall</span><br><span class="line">        - nx</span><br><span class="line">        - rdtscp</span><br><span class="line">        - lm</span><br><span class="line">        - constant_tsc</span><br><span class="line">        - nopl</span><br><span class="line">        - xtopology</span><br><span class="line">        - nonstop_tsc</span><br><span class="line">        - eagerfpu</span><br><span class="line">        - pni</span><br><span class="line">        - pclmulqdq</span><br><span class="line">        - ssse3</span><br><span class="line">        - fma</span><br><span class="line">        - cx16</span><br><span class="line">        - pcid</span><br><span class="line">        - sse4_1</span><br><span class="line">        - sse4_2</span><br><span class="line">        - x2apic</span><br><span class="line">        - movbe</span><br><span class="line">        - popcnt</span><br><span class="line">        - tsc_deadline_timer</span><br><span class="line">        - aes</span><br><span class="line">        - xsave</span><br><span class="line">        - avx</span><br><span class="line">        - f16c</span><br><span class="line">        - rdrand</span><br><span class="line">        - hypervisor</span><br><span class="line">        - lahf_lm</span><br><span class="line">        - abm</span><br><span class="line">        - 3dnowprefetch</span><br><span class="line">        - fsgsbase</span><br><span class="line">        - tsc_adjust</span><br><span class="line">        - bmi1</span><br><span class="line">        - hle</span><br><span class="line">        - avx2</span><br><span class="line">        - smep</span><br><span class="line">        - bmi2</span><br><span class="line">        - invpcid</span><br><span class="line">        - mpx</span><br><span class="line">        - adx</span><br><span class="line">        - clflushopt</span><br><span class="line">        - xsaveopt</span><br><span class="line">        - dtherm</span><br><span class="line">        - arat</span><br><span class="line">        - pln</span><br><span class="line">        - pts</span><br><span class="line">    cpu_model:</span><br><span class="line">        Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz</span><br><span class="line">    cpuarch:</span><br><span class="line">        x86_64</span><br><span class="line">    disks:</span><br><span class="line">        - sr0</span><br><span class="line">    dns:</span><br><span class="line">        ----------</span><br><span class="line">        domain:</span><br><span class="line">        ip4_nameservers:</span><br><span class="line">            - 192.168.1.1</span><br><span class="line">        ip6_nameservers:</span><br><span class="line">        nameservers:</span><br><span class="line">            - 192.168.1.1</span><br><span class="line">        options:</span><br><span class="line">        search:</span><br><span class="line">            - lan</span><br><span class="line">        sortlist:</span><br><span class="line">    domain:</span><br><span class="line">    fqdn:</span><br><span class="line">        salt_salve_2</span><br><span class="line">    fqdn_ip4:</span><br><span class="line">        - 192.168.1.145</span><br><span class="line">    fqdn_ip6:</span><br><span class="line">        - fe80::d0f:e7bc:6a7f:a752</span><br><span class="line">    gid:</span><br><span class="line">        0</span><br><span class="line">    gpus:</span><br><span class="line">        |_</span><br><span class="line">          ----------</span><br><span class="line">          model:</span><br><span class="line">              Accelerated Virtual Video Adapter</span><br><span class="line">          vendor:</span><br><span class="line">              unknown</span><br><span class="line">    groupname:</span><br><span class="line">        root</span><br><span class="line">    host:</span><br><span class="line">        salt_salve_2</span><br><span class="line">    hwaddr_interfaces:</span><br><span class="line">        ----------</span><br><span class="line">        eth0:</span><br><span class="line">            00:1c:42:bb:de:e6</span><br><span class="line">        lo:</span><br><span class="line">            00:00:00:00:00:00</span><br><span class="line">    id:</span><br><span class="line">        newdev</span><br><span class="line">    init:</span><br><span class="line">        systemd</span><br><span class="line">    ip4_gw:</span><br><span class="line">        192.168.1.1</span><br><span class="line">    ip4_interfaces:</span><br><span class="line">        ----------</span><br><span class="line">        eth0:</span><br><span class="line">            - 192.168.1.145</span><br><span class="line">        lo:</span><br><span class="line">            - 127.0.0.1</span><br><span class="line">    ip6_gw:</span><br><span class="line">        False</span><br><span class="line">    ip6_interfaces:</span><br><span class="line">        ----------</span><br><span class="line">        eth0:</span><br><span class="line">            - fe80::d0f:e7bc:6a7f:a752</span><br><span class="line">        lo:</span><br><span class="line">            - ::1</span><br><span class="line">    ip_gw:</span><br><span class="line">        True</span><br><span class="line">    ip_interfaces:</span><br><span class="line">        ----------</span><br><span class="line">        eth0:</span><br><span class="line">            - 192.168.1.145</span><br><span class="line">            - fe80::d0f:e7bc:6a7f:a752</span><br><span class="line">        lo:</span><br><span class="line">            - 127.0.0.1</span><br><span class="line">            - ::1</span><br><span class="line">    ipv4:</span><br><span class="line">        - 127.0.0.1</span><br><span class="line">        - 192.168.1.145</span><br><span class="line">    ipv6:</span><br><span class="line">        - ::1</span><br><span class="line">        - fe80::d0f:e7bc:6a7f:a752</span><br><span class="line">    kernel:</span><br><span class="line">        Linux</span><br><span class="line">    kernelrelease:</span><br><span class="line">        3.10.0-862.el7.x86_64</span><br><span class="line">    kernelversion:</span><br><span class="line">        #1 SMP Fri Apr 20 16:44:24 UTC 2018</span><br><span class="line">    locale_info:</span><br><span class="line">        ----------</span><br><span class="line">        defaultencoding:</span><br><span class="line">            UTF-8</span><br><span class="line">        defaultlanguage:</span><br><span class="line">            en_US</span><br><span class="line">        detectedencoding:</span><br><span class="line">            UTF-8</span><br><span class="line">    localhost:</span><br><span class="line">        salt_salve_2</span><br><span class="line">    lsb_distrib_codename:</span><br><span class="line">        CentOS Linux 7 (Core)</span><br><span class="line">    lsb_distrib_id:</span><br><span class="line">        CentOS Linux</span><br><span class="line">    machine_id:</span><br><span class="line">        4759594b77c0c04fb629ee0b4da6fdbe</span><br><span class="line">    manufacturer:</span><br><span class="line">        Parallels Software International Inc.</span><br><span class="line">    master:</span><br><span class="line">        192.168.1.194</span><br><span class="line">    mdadm:</span><br><span class="line">    mem_total:</span><br><span class="line">        1222</span><br><span class="line">    nodename:</span><br><span class="line">        localhost.localdomain</span><br><span class="line">    num_cpus:</span><br><span class="line">        2</span><br><span class="line">    num_gpus:</span><br><span class="line">        1</span><br><span class="line">    os:</span><br><span class="line">        CentOS</span><br><span class="line">    os_family:</span><br><span class="line">        RedHat</span><br><span class="line">    osarch:</span><br><span class="line">        x86_64</span><br><span class="line">    oscodename:</span><br><span class="line">        CentOS Linux 7 (Core)</span><br><span class="line">    osfinger:</span><br><span class="line">        CentOS Linux-7</span><br><span class="line">    osfullname:</span><br><span class="line">        CentOS Linux</span><br><span class="line">    osmajorrelease:</span><br><span class="line">        7</span><br><span class="line">    osrelease:</span><br><span class="line">        7.5.1804</span><br><span class="line">    osrelease_info:</span><br><span class="line">        - 7</span><br><span class="line">        - 5</span><br><span class="line">        - 1804</span><br><span class="line">    path:</span><br><span class="line">        /usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">    pid:</span><br><span class="line">        24821</span><br><span class="line">    productname:</span><br><span class="line">        Parallels Virtual Platform</span><br><span class="line">    ps:</span><br><span class="line">        ps -efHww</span><br><span class="line">    pythonexecutable:</span><br><span class="line">        /usr/bin/python</span><br><span class="line">    pythonpath:</span><br><span class="line">        - /usr/bin</span><br><span class="line">        - /usr/lib64/python27.zip</span><br><span class="line">        - /usr/lib64/python2.7</span><br><span class="line">        - /usr/lib64/python2.7/plat-linux2</span><br><span class="line">        - /usr/lib64/python2.7/lib-tk</span><br><span class="line">        - /usr/lib64/python2.7/lib-old</span><br><span class="line">        - /usr/lib64/python2.7/lib-dynload</span><br><span class="line">        - /usr/lib64/python2.7/site-packages</span><br><span class="line">        - /usr/lib/python2.7/site-packages</span><br><span class="line">    pythonversion:</span><br><span class="line">        - 2</span><br><span class="line">        - 7</span><br><span class="line">        - 5</span><br><span class="line">        - final</span><br><span class="line">        - 0</span><br><span class="line">    saltpath:</span><br><span class="line">        /usr/lib/python2.7/site-packages/salt</span><br><span class="line">    saltversion:</span><br><span class="line">        2018.3.2</span><br><span class="line">    saltversioninfo:</span><br><span class="line">        - 2018</span><br><span class="line">        - 3</span><br><span class="line">        - 2</span><br><span class="line">        - 0</span><br><span class="line">    selinux:</span><br><span class="line">        ----------</span><br><span class="line">        enabled:</span><br><span class="line">            True</span><br><span class="line">        enforced:</span><br><span class="line">            Enforcing</span><br><span class="line">    serialnumber:</span><br><span class="line">        Parallels-4B 59 59 47 C0 77 4F C0 B6 29 EE 0B 4D A6 FD BE</span><br><span class="line">    server_id:</span><br><span class="line">        2082849409</span><br><span class="line">    shell:</span><br><span class="line">        /bin/bash</span><br><span class="line">    swap_total:</span><br><span class="line">        2047</span><br><span class="line">    systemd:</span><br><span class="line">        ----------</span><br><span class="line">        features:</span><br><span class="line">            +PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN</span><br><span class="line">        version:</span><br><span class="line">            219</span><br><span class="line">    uid:</span><br><span class="line">        0</span><br><span class="line">    username:</span><br><span class="line">        root</span><br><span class="line">    uuid:</span><br><span class="line">        4759594b-77c0-c04f-b629-ee0b4da6fdbe</span><br><span class="line">    virtual:</span><br><span class="line">        Parallels</span><br><span class="line">    zfs_feature_flags:</span><br><span class="line">        False</span><br><span class="line">    zfs_support:</span><br><span class="line">        False</span><br><span class="line">    zmqversion:</span><br><span class="line">        4.1.4</span><br></pre></td></tr></table></figure>

<p># Pillar</p>
<p>Pillar主要用于master端分发给minion端的信息，针对于Grains不同的是它是<code>动态加密</code>传输的，而且只有指定minion才能收到这些pillar信息。</p>
<p>通过<code>salt &#39;*&#39; pillar.items</code> 来展示pillar信息，通过<code>salt &#39;*&#39; saltutil.refresh_pillar</code> 来刷新pillar信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">newdev:</span><br><span class="line">    ----------</span><br><span class="line">    groups:</span><br><span class="line">        |_</span><br><span class="line">          ----------</span><br><span class="line">          name:</span><br><span class="line">              dev</span><br><span class="line">          nodes:</span><br><span class="line">              - dev</span><br><span class="line">              - newdev</span><br><span class="line">    sshd_port:</span><br><span class="line">        22</span><br></pre></td></tr></table></figure>

<h1 id="High-State-与-Low-State"><a href="#High-State-与-Low-State" class="headerlink" title="High State 与 Low State"></a>High State 与 Low State</h1><p>如果什么配置都没问题以后可以通过 <code>salt &#39;*&#39; state.highstate</code> 完成所有机器的部署动作。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-08-09</span><i class="fa fa-tag"></i><a class="tag" href="/tags/运维/" title="运维">运维 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/saltStack/" title="saltStack">saltStack </a><i class="fa fa-tag"></i><a class="tag" href="/tags/django/" title="django">django </a><span>About 663 words, 2 min 12 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/08/05/2018-08-05-Zend%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%A6%E4%B9%A0/">Zend虚拟机学习</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>Zend虚拟机（Zend VM）是PHP语言的核心，承担了语法和词法分析、AST变异以及指令的执行工作。</p>
</blockquote>
<h2 id="Zend虚拟机架构"><a href="#Zend虚拟机架构" class="headerlink" title="Zend虚拟机架构"></a>Zend虚拟机架构</h2><p><img src="http://img.yuekang.org.cn/2018080501.jpg" alt="zend架构图"></p>
<ul>
<li>解释层</li>
</ul>
<p>这一层主要负责对PHP代码进行词法和语法分析，生成对应的AST。另一个工作就是对AST进行编译，生成符号表和指令集。</p>
<ul>
<li>中间数据层</li>
</ul>
<p>这一层主要包含了虚拟机的核心部分–执行栈的维护、指令集和符号表的存储，而这些是执行引擎调度执行的基础。</p>
<ul>
<li>执行层</li>
</ul>
<p>这一层是执行命令集的引擎，负责最终的执行并生成结果，这一层实现了大量的底层函数。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-08-05</span><i class="fa fa-tag"></i><a class="tag" href="/tags/PHP/" title="PHP">PHP </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Zend虚拟机/" title="Zend虚拟机">Zend虚拟机 </a><span>About 200 words, 40 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/07/30/2018-07-30-saltStack-%E6%90%AD%E5%BB%BA/">saltStack 搭建</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>SaltStack是一个服务器基础架构集中化管理平台，具备配置管理、远程执行、监控等功能，一般可以理解为简化版的puppet和加强版的func。SaltStack基于Python语言实现，结合轻量级消息队列（ZeroMQ）与Python第三方模块（Pyzmq、PyCrypto、Pyjinjia2、python-msgpack和PyYAML等）构建。<br>通过部署SaltStack环境，我们可以在成千上万台服务器上做到批量执行命令，根据不同业务特性进行配置集中化管理、分发文件、采集服务器数据、操作系统基础及软件包管理等，SaltStack是运维人员提高工作效率、规范业务配置与操作的利器。</p>
</blockquote>
<p><img src="http://img.yuekang.org.cn/2018073001.png" alt=""></p>
<p>组成形式<br><img src="http://img.yuekang.org.cn/2018073101.png"></p>
<p>配置文件从top.sls为入口，这里面定义所有文件信息。</p>
<h1 id="基础环境搭建"><a href="#基础环境搭建" class="headerlink" title="基础环境搭建"></a>基础环境搭建</h1><h3 id="服务端安装脚本"><a href="#服务端安装脚本" class="headerlink" title="服务端安装脚本"></a>服务端安装脚本</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class="line">sudo sh install_salt.sh -P -M</span><br></pre></td></tr></table></figure>

<h3 id="客户端安装脚本"><a href="#客户端安装脚本" class="headerlink" title="客户端安装脚本"></a>客户端安装脚本</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -L https://bootstrap.saltstack.com -o install_salt.sh</span><br><span class="line">sudo sh install_salt.sh -P</span><br></pre></td></tr></table></figure>

<p> 指定<code>-P</code>  代表着 master 安装</p>
<h1 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h1><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/salt/master</span></span><br><span class="line"></span><br><span class="line"><span class="string">//配置主服务器地址</span></span><br><span class="line"><span class="attr">interface:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.192</span></span><br><span class="line"></span><br><span class="line"><span class="string">//以哪个用户运行</span></span><br><span class="line"><span class="attr">user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">//指定salt配置路径</span></span><br><span class="line"><span class="attr">file_roots:</span></span><br><span class="line">  <span class="attr">base:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/root/saltstack/salt/base</span></span><br><span class="line">  <span class="attr">prod:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/root/saltstack/salt/prod</span></span><br><span class="line"></span><br><span class="line"><span class="string">//环境配置文件</span></span><br><span class="line"><span class="attr">pillar_roots:</span></span><br><span class="line">  <span class="attr">base:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/root/saltstack/pillar/base</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">/etc/salt/minion</span></span><br><span class="line"></span><br><span class="line"><span class="string">//指定主服务器ip</span></span><br><span class="line"><span class="attr">master:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.192</span></span><br><span class="line"></span><br><span class="line"><span class="string">//指定机器ID</span> <span class="string">不要重名！</span> </span><br><span class="line"><span class="attr">id:</span> <span class="string">salt_slave_01</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此刻就配置完毕，进入调试连接部分</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">//打开客户端的debug模式(注意，必须关闭salt-minion服务，否则会提示端口占用，debug模式单独跑的！调试完毕以后在启动salt-minion服务)</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@salt_slave_01:~#</span> <span class="string">salt-minion</span> <span class="string">-l</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="string">//进入master，查看授权列表</span></span><br><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># salt-key -L</span></span><br><span class="line"><span class="attr">Accepted Keys:</span>  <span class="string">//同意的key</span></span><br><span class="line"><span class="attr">Denied Keys:</span>    <span class="string">//拒绝的key</span></span><br><span class="line"><span class="attr">Unaccepted Keys:</span> <span class="string">//未接受的key</span></span><br><span class="line"><span class="string">salt_slave_01</span></span><br><span class="line"><span class="string">salt_slave_02</span></span><br><span class="line"><span class="attr">Rejected Keys:</span> <span class="string">//被拒绝的key</span></span><br><span class="line"></span><br><span class="line"><span class="string">//可以看到已经有两个minion请求授权了</span></span><br><span class="line"><span class="string">//授权主机</span></span><br><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># salt-key -a salt_slave1</span></span><br><span class="line"></span><br><span class="line"><span class="string">//全部授权</span></span><br><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># salt-key -A</span></span><br><span class="line"></span><br><span class="line"><span class="string">//授权结束以后就完成了master和minion的连接动作</span></span><br><span class="line"></span><br><span class="line"><span class="string">//测试和子节点的连通性</span></span><br><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># salt &#x27;*&#x27; test.ping</span></span><br><span class="line"><span class="attr">salt_slave_01:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="attr">salt_slave_02:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="string">//安装配置文件中的服务，并同步所有配置文件数据</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">sate.highstate</span></span><br><span class="line"><span class="string">``</span></span><br><span class="line"><span class="string">至此完成全部salt软件安装服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令附录</span></span><br><span class="line"></span><br><span class="line"><span class="string">```shell</span></span><br><span class="line"><span class="string">***********模块***********</span></span><br><span class="line"><span class="string">查看模块列表module</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_modules</span></span><br><span class="line"><span class="string">查看指定module的function用法</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_functions</span> <span class="string">file</span></span><br><span class="line"><span class="string">查看指定模块的详细用法</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.doc</span> <span class="string">cmd</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********模块使用说明***********</span></span><br><span class="line"><span class="string">查看配置管理state模块列表</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_state_modules</span></span><br><span class="line"><span class="string">查看配置管理sate列表指定模块所有方法列表</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_state_functions</span> <span class="string">svn</span></span><br><span class="line"><span class="string">查看配置管理state列表指定模块详细用法</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.state_doc</span> <span class="string">file</span></span><br><span class="line"><span class="string">查看配置管理state列表指定模块的方法分支</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.state_doc</span> <span class="string">file.managed</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********pillar变量***********</span></span><br><span class="line"><span class="string">查看主机对应的所有pillar变量值</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">pillar.data</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">pillar.items</span></span><br><span class="line"><span class="string">查看主机对应的多个pillar变量值</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">pillar.item</span> <span class="string">roles</span> <span class="string">appname</span></span><br><span class="line"><span class="string">修改pillar值后需要刷新pillar数据</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">saltutil.refresh_pillar</span></span><br><span class="line"><span class="string">查看pillar模块详细用法,其他类似</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.doc</span> <span class="string">pillar</span></span><br><span class="line"><span class="string">查看pillar的相关方法</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_functions</span> <span class="string">pillar</span></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">shuke:</span></span><br><span class="line"><span class="string">    - pillar.data</span></span><br><span class="line"><span class="string">    - pillar.ext</span></span><br><span class="line"><span class="string">    - pillar.get</span></span><br><span class="line"><span class="string">    - pillar.item</span></span><br><span class="line"><span class="string">    - pillar.items</span></span><br><span class="line"><span class="string">    - pillar.raw</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********grains变量***********</span></span><br><span class="line"><span class="string">查看模块用法</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.list_functions</span> <span class="string">grains</span></span><br><span class="line"><span class="string">查看item项</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">grains.ls</span></span><br><span class="line"><span class="string">查看所有iteams</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">grains.items</span></span><br><span class="line"><span class="string">获得某个item值</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">grains.get</span> <span class="string">os</span></span><br><span class="line"><span class="string">同步_grains目录下的py脚本至minion</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">saltutil.sync_all</span></span><br><span class="line"><span class="string">如果py模块有修改,修改后进行重载</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sys.reload_modules</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********minions在线状态***********</span></span><br><span class="line"><span class="string">查看所有minion状态</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">manage.status</span></span><br><span class="line"><span class="string">查看所有minion在线状态</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">manage.up</span></span><br><span class="line"><span class="string">查看所有minion不在线状态</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">manage.down</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********key管理***********</span></span><br><span class="line"><span class="string">salt-key</span> <span class="string">密钥管理，通常在master端执行</span></span><br><span class="line"><span class="string">salt-key</span> [<span class="string">options</span>]</span><br><span class="line"><span class="string">salt-key</span> <span class="string">-L</span>              <span class="comment">##查看所有minion-key</span></span><br><span class="line"><span class="string">salt-key</span> <span class="string">-a</span> <span class="string">&lt;key-name&gt;</span>   <span class="comment">##接受某个minion-key</span></span><br><span class="line"><span class="string">salt-key</span> <span class="string">-d</span> <span class="string">&lt;key-name&gt;</span>   <span class="comment">##删除某个minion-key</span></span><br><span class="line"><span class="string">salt-key</span> <span class="string">-A</span>              <span class="comment">##接受所有的minion-key</span></span><br><span class="line"><span class="string">salt-key</span> <span class="string">-D</span>              <span class="comment">##删除所有的minion-key</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********salt-call相关***********</span></span><br><span class="line"><span class="string">salt-call</span> <span class="string">该命令通常在minion上执行，minion自己执行可执行模块，不是通过master下发job</span></span><br><span class="line"><span class="string">salt-call</span> [<span class="string">options</span>] <span class="string">&lt;function&gt;</span> [<span class="string">arguments</span>]</span><br><span class="line"><span class="string">salt-call</span> <span class="string">test.ping</span>           			<span class="comment">##自己执行test.ping命令</span></span><br><span class="line"><span class="string">salt-call</span> <span class="string">cmd.run</span> <span class="string">&#x27;ifconfig&#x27;</span>  			<span class="comment">##自己执行cmd.run函数</span></span><br><span class="line"></span><br><span class="line"><span class="string">***********文件分发***********</span></span><br><span class="line"><span class="string">salt-cp</span> <span class="string">分发文件到minion上,不支持目录分发，通常在master运行</span></span><br><span class="line"><span class="string">salt-cp</span> [<span class="string">options</span>] <span class="string">&#x27;&lt;target&gt;&#x27;</span> <span class="string">SOURCE</span> <span class="string">DEST</span></span><br><span class="line"><span class="string">salt-cp</span> <span class="string">&#x27;*&#x27;</span> <span class="string">testfile.html</span> <span class="string">/tmp</span></span><br><span class="line"><span class="string">salt-cp</span> <span class="string">&#x27;test*&#x27;</span> <span class="string">index.html</span> <span class="string">/tmp/a.html</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;S1_0_001_Room&#x27;</span> <span class="string">cp.get_dir</span> <span class="string">salt://package</span> <span class="string">/tmp</span> <span class="string">-v</span>  <span class="string">同步目录</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;S1_0_001_Room&#x27;</span> <span class="string">cp.get_file</span> <span class="string">salt://package/minions.tar.gz</span> <span class="string">/tmp/minions.tar.gz</span> <span class="string">gzip=5</span>    <span class="string">同步文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">**********其他***********</span></span><br><span class="line"><span class="string">salt-run</span> <span class="string">jobs.active</span>            <span class="comment">#查看所有minion当前正在运行的jobs</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">saltutil.running</span>       <span class="comment"># 查看正在运行的任务，找到jid</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">saltutil.kill_job</span> <span class="string">jid</span>  <span class="comment"># 根据jid杀掉任务</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">saltutil.clear_cache</span>   <span class="comment"># 清除minion缓存</span></span><br><span class="line"></span><br><span class="line"><span class="string">执行单个命令</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">cmd.run</span> <span class="string">&#x27;ps -ef | grep mongod&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">测试单个sls模块</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.sls</span> <span class="string">nginx</span> <span class="string">test=True</span></span><br><span class="line"></span><br><span class="line"><span class="string">执行前进行测试</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.highstate</span> <span class="string">test=True</span></span><br><span class="line"></span><br><span class="line"><span class="string">在所有minion上执行状态:</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">sate.highstate</span></span><br><span class="line"></span><br><span class="line"><span class="string">获取执行jib任务的md5值</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">hashutil.md5_digest</span> <span class="number">20170202150211366486</span></span><br><span class="line"></span><br><span class="line"><span class="string">low数据可以使用state.show_lowstate方法查看</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.show_lowstate</span> <span class="string">--out</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">High</span> <span class="string">State数据可以使用state.show_hoghstate方法查看</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.show_highstate</span> <span class="string">--out</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看highstate</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.show_highstate</span></span><br><span class="line"><span class="comment">#查看lowdata</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;minion&#x27;</span> <span class="string">state.show_lowstate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行所有top.sls</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">state.apply</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行指定环境下top.sls</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">state.apply</span> <span class="string">saltenv=dev</span></span><br><span class="line"></span><br><span class="line"><span class="string">注:</span></span><br><span class="line"><span class="string">name：要执行的命令，记住该命令将会在salt-minion的路径和权限下执行</span></span><br><span class="line"><span class="string">onlyif：用于检查的命令，仅当``onlyif``选项指向的命令返回true时才执行name定义的命令</span></span><br><span class="line"><span class="string">unless：用于检查的命令，仅当``unless``选项指向的命令返回false时才执行name指向的命令</span></span><br><span class="line"></span><br><span class="line"><span class="string">查看wyd用户下进程</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-N</span> <span class="string">&#x27;Z1_S2&#x27;</span> <span class="string">cmd.run</span> <span class="string">&#x27;su -c &quot;ps -u wyd | grep -v top | grep -v bash | grep -v sshd | grep -v grep | grep -v ps | grep -v CMD &quot; wyd&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">state中(钩子函数)</span></span><br><span class="line"><span class="string">requisiterequisite:require/watch/onchanges/onfail/use/prereq/require_in(反转)</span></span><br><span class="line"></span><br><span class="line"><span class="string">========Targeting</span> <span class="string">Minion=======</span></span><br><span class="line"><span class="comment">#Glob(默认)</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;*&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">\*</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#PCRE 正则表达式</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-E</span> <span class="string">&#x27;^[m|M]in.[e|o|u]n$&#x27;</span> <span class="string">test.ping</span> <span class="string">=</span> <span class="string">salt</span> <span class="string">-E</span> <span class="string">&#x27;^[mM]in.[eou]n$&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#list</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-L</span> <span class="string">web1,web2,db1</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Subnet</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-S</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-S</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Grain</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-G</span> <span class="string">&#x27;os:ubuntu&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-G</span> <span class="string">&#x27;os_family:Debian&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-G</span> <span class="string">&#x27;ip_interfaces:eth0:192.168.1.100&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-G</span> <span class="string">&#x27;ipv6:::1&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">--grain-pcre</span> <span class="string">&#x27;os:red(hat|flag)&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Pillar</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-I</span> <span class="string">&#x27;my_var:my_val&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#混合(Compound)</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-C</span> <span class="string">&#x27;G@os:Ubuntu,I@role:web,S@192.168.1.100/24&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-C</span> <span class="string">&#x27;min* or *ion&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-C</span> <span class="string">&#x27;web* or *qa,G@os:Arch&#x27;</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Nodegroup</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-N</span>　<span class="string">webdev</span> <span class="string">test.ping</span></span><br><span class="line"></span><br><span class="line"><span class="string">添加计划任务</span></span><br><span class="line"><span class="string">salt</span> <span class="string">&#x27;S1_*_Center&#x27;</span> <span class="string">cron.set_job</span> <span class="string">root</span>   <span class="string">&#x27;0&#x27;</span> <span class="string">&#x27;5&#x27;</span> <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;*&#x27;</span>  <span class="string">&#x27;/usr/sbin/logrotate -vf /etc/logrotate.d/acl &gt;/tmp/cutacl_log 2&gt;&amp;1&#x27;</span> <span class="string">identifier=cutacl</span></span><br><span class="line"></span><br><span class="line"><span class="string">删除计划任务</span></span><br><span class="line"><span class="string">salt</span> <span class="string">-C</span> <span class="string">&#x27;E@S1_(10001|10002|10003)_*&#x27;</span> <span class="string">cron.rm_job</span> <span class="string">wyd</span> <span class="string">&#x27;cd /data/wyd/game_server_1.2.0/log;find . -type f -mtime +15 -name &quot;*.log*&quot; -exec rm -rf &#123;&#125; \; 2&gt;&amp;1&#x27;</span> <span class="string">identifier=&#x27;clear</span> <span class="string">log&#x27;</span></span><br></pre></td></tr></table></figure>







</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-07-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/运维/" title="运维">运维 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/saltStack/" title="saltStack">saltStack </a><span>About 1868 words, 6 min 13 sec  read</span></div></div></div></div><div class="post animated"><div class="post-title"><h3><a href="/2018/07/22/2018-07-22-jumperServer/">jumperServer</a></h3></div><div class="post-content"><div class="card"><p><blockquote>
<p>JumpeServer 是用Python+Django开发的跳板机及堡垒机于一身的开源项目，并通过与OpenLDAP的结合可对服务器实现Web端账号、密码管理、权限管理、主机管理，并实现Web端监控和审计，提供上传文件的功能。其主要功能有以下几个。</p>
</blockquote>
<ol>
<li>用户管理（认证）</li>
<li>资产管理</li>
<li>授权管理（授权）</li>
<li>监控审计（审计）</li>
<li>文件上传</li>
</ol>
<h3 id="JumperServer-由以下部分组成"><a href="#JumperServer-由以下部分组成" class="headerlink" title="JumperServer 由以下部分组成"></a>JumperServer 由以下部分组成</h3><p><img src="http://img.yuekang.org.cn/2018072201.png" alt="JumperServer"></p>
<p>官方网站：<a href="https://jumpserver.readthedocs.io/zh/docs/snapshot.html">https://jumpserver.readthedocs.io/zh/docs/snapshot.html</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-07-22</span><i class="fa fa-tag"></i><a class="tag" href="/tags/堡垒机/" title="堡垒机">堡垒机 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/jumperserver/" title="jumperserver">jumperserver </a><i class="fa fa-tag"></i><a class="tag" href="/tags/运维/" title="运维">运维 </a><span>About 144 words, 28 sec  read</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/3/">Next</a></li></ul></div></div></div></div></main-outlet><script>(async function(){ if (Anatolo.search == null) await Anatolo.getMsg("search-init"); Anatolo.search.config = {translation:{posts:"Posts",pages:"Pages",categories:"Categories",tags:"Tags",untitled:"(Untitled)",} }; })()</script><div class="searchbox ins-search modal-cover"><div class="searchbox-container ins-search-container modal-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="Anatolo.search.closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><button class="float-button hide" id="scroll-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" type="button" title="Scroll to top"><i class="fa fa-angle-up"></i></button><div class="modal-cover" id="success-indicator"><div class="modal-container indicator"><i class="fa fa-check"></i></div></div></body></html>