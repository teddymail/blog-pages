{"title":"实现SOAP接口得适配","date":"2017-04-17T09:12:19.000Z","source":"_posts/2017-04-17.实现SOAP接口得适配.md","raw":"---\ntitle: 实现SOAP接口得适配\ndate: 2017-04-17 17:12:19\ntags: [PHP]\n---\n\n> 博主工作一周了，上一周里遇到了一个难题，就是对方提供的是SOAP协议制作出来的接口，让我们进行适配，其实这个技术已经淘汰了，不过对方是erp也不可能因为你而改写什么对吧，这里我们就分析一下怎么解决这个问题。\n\n\n## SOAP（Simple Object Access Protocol） 简单对象访问协议\n\n>SOAP是基于XML的建议协议，可使用应用程序的HTTP之上进行信息交换或简单地说：SOAP使用用于访问网络服务的协议。\n\n1. 什么是SOAP？\n  * SOAP 指__简易对象访问协议__\n  * SOAP 是一种__通信协议__\n  * SOAP 用于__应用程序之间__的通信\n  * SOAP 是一种__发送消息__的格式\n  * SOAP 被设计用来__通过因特网__进行通信\n  * SOAP __独立于平台__\n  * SOAP __独立于语言__\n  * SOAP __基于XML__\n  * SOAP __很简单并可扩展__\n  * SOAP 允许你__绕过防火墙__\n  * SOAP 将被作为__W3C标准__来发展\n\n2.\n![SOAP](http://img.yuekang.org.cn/blog/images/2017041701.gif)\n\n\n\n\n6.约定的交互格式交互格式\n```XML\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:sen=\"http://pi.want-want.com/ZRFCARW_1/Sender_Syn\">\n   <soapenv:Header/>\n   <soapenv:Body>\n      <sen:MT_ZRFCARW01_Req>\n         <!--Optional:-->\n         <IM_OBJID>{json数据}</IM_OBJID>\n      </sen:MT_ZRFCARW01_Req>\n   </soapenv:Body>\n</soapenv:Envelope>\n```\n\n```XML\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:sen=\"http://pi.want-want.com/ZRFCARW_2/Sender_Syn\">\n   <soapenv:Header/>\n   <soapenv:Body>\n      <sen:MT_ZRFCARW02_Req>\n         <!--Optional:-->\n         <IM_JSON>{json数据}</IM_JSON>\n      </sen:MT_ZRFCARW02_Req>\n   </soapenv:Body>\n</soapenv:Envelope>\n\n```\n\n7. 鉴权方式\n   -- BaseAuthor验证方式\n\n\n\n----\n\n##### 解决办法\n1. 通过对方提供wsdl文档文件，使用soapUI软件进行测试解析\n* soapUI工具图：\n\n![soapUI工具图](http://img.yuekang.org.cn/blog/images/2017042101.png)\n\n>当我们使用这个工具跑通接口后，这个时候还没有完成我们还必须要使用一个工具就是postman这个接口测试工具，有人可能要问了，为啥用soapui这个工具呢？答案是：交互数据接口，我们需要读取wsdl文件啊，才能知道交互的数据结构呢。\n\n2. 使用postman软件进行接口的再次测试。\n\n* 从soapUI中获取相关信息进行解析使用postman进行测试\n\n![测试图1](http://img.yuekang.org.cn/blog/images/2017042103.jpg)\n\n* 填入交互数据\n\n![交互数据图](http://img.yuekang.org.cn/blog/images/2017042104.jpg)\n\n* 返回的结果图\n\n![返回结果图](http://img.yuekang.org.cn/blog/images/2017042102.jpg)\n\n>我们获取到了正式的数据，我们还需要提取xml中的json数据，我得解决方案是通过正则匹配的形式提取json，还有另一种办法，因为数据的格式还是比较简单的，也可以采取替换的原则，去掉json的前后无用的xml标签数据\n\n---\n###### 一下是我写的通信代码\n\n```PHP\nfunction ApiNetManager($json = null, $isID = true)\n{\n    //根地址\n    $baseUrl = 'url';\n    $port = 'port';\n    $username = 'username';\n    $password = 'password';\n    //统一消息返回格式\n    $info = array(\n        'code' => 0,\n        'message' => '',\n        'data' => null\n    );\n    //验证json的正确性\n    if (is_null(json_decode($json))) {\n        return false;\n    }\n\n    //构建网络请求\n    $curl = curl_init();\n    if ($isID) {//验证课程ID\n        curl_setopt_array($curl, array(\n            CURLOPT_PORT => $port,\n            CURLOPT_URL => $baseUrl . ':' . $port . \"/XISOAPAdapter/MessageServlet?senderParty=&senderService=BC_OEXAM&receiverParty=&receiverService=&interface=SI_ZRFCARW01_Out_Syn&interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_1%2FSender_Syn\",\n            CURLOPT_RETURNTRANSFER => true,\n            CURLOPT_ENCODING => \"utf8\",\n            CURLOPT_MAXREDIRS => 10,\n            CURLOPT_TIMEOUT => 30,\n            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,\n            CURLOPT_CUSTOMREQUEST => \"POST\",\n            CURLOPT_POSTFIELDS => \"<soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sen=\\\"http://pi.want-want.com/ZRFCARW_1/Sender_Syn\\\"><soapenv:Header/><soapenv:Body><sen:MT_ZRFCARW01_Req><IM_OBJID>{$json}</IM_OBJID></sen:MT_ZRFCARW01_Req></soapenv:Body></soapenv:Envelope>\",\n            CURLOPT_HTTPHEADER => array(\n                \"authorization: Basic \" . base64_encode($username . ':' . $password),\n                \"cache-control: no-cache\",\n                \"content-type: application/xml\",\n            ),\n        ));\n\n    } else {//回传考试成绩接口\n        curl_setopt_array($curl, array(\n            CURLOPT_PORT => \"50000\",\n            CURLOPT_URL => $baseUrl . ':' . $port . \"/XISOAPAdapter/MessageServlet?senderParty=&senderService=BC_OEXAM&receiverParty=&receiverService=&interface=SI_ZRFCARW02_Out_Syn&interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_2%2FSender_Syn\",\n            CURLOPT_RETURNTRANSFER => true,\n            CURLOPT_ENCODING => \"\",\n            CURLOPT_MAXREDIRS => 10,\n            CURLOPT_TIMEOUT => 30,\n            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,\n            CURLOPT_CUSTOMREQUEST => \"POST\",\n            CURLOPT_POSTFIELDS => \"<soapenv:Envelope xmlns:soapenv=\\\"http://schemas.xmlsoap.org/soap/envelope/\\\" xmlns:sen=\\\"http://pi.want-want.com/ZRFCARW_2/Sender_Syn\\\"><soapenv:Header/><soapenv:Body><sen:MT_ZRFCARW02_Req><IM_JSON>{$json}</IM_JSON></sen:MT_ZRFCARW02_Req></soapenv:Body></soapenv:Envelope>\",\n            CURLOPT_HTTPHEADER => array(\n                \"authorization: Basic \" . base64_encode($username . ':' . $password),\n                \"cache-control: no-cache\",\n                \"content-type: application/xml\",\n            ),\n        ));\n    }\n    //执行网络请求\n    $response = curl_exec($curl);\n    $err = curl_error($curl);\n    if ($err) {\n        $info['code'] = 500;\n        $info['message'] = '服务器异常，请稍后再试';\n    } else if (strstr($response, '<title>Error Report</title>')) {//请求成功权限没有通过\n        $info['code'] = 302;\n        $info['message'] = '服务器请求权限未通过请联系管理员!';\n    } else {//请求并权限通过\n        if ($isID) {//验证课程id的json查找\n            preg_match(\"/{.+}/\", $response, $match);//查找json\n        } else {//考试成绩回传的json查找\n            preg_match('/\\[{.*?\\}]/is', $response, $match);\n        }\n        $jsonArr = json_decode($match[0], true);//解析json\n        $info['code'] = 200;\n        $info['message'] = '请求成功，成功返回数据';\n        $info['data'] = $jsonArr;\n    }\n    return $info['code'] == 0 ? false : $info;\n}\n```\n\n> 至此我们完成了数据的代码的填写，相关具体测试我就不多说了，这里我加入了标准的接口返回形式，一边后续的代码可以更加精确地判断问题出在哪里，好了就到这里，谢谢大家的观看。\n","slug":"2017-04-17-实现SOAP接口得适配","published":true,"updated":"2024-09-08T06:14:16.946Z","_id":"cm0w4eg0w000fetsn2hz61ckh","comments":true,"layout":"post","photos":[],"html":"<blockquote>\n<p>博主工作一周了，上一周里遇到了一个难题，就是对方提供的是SOAP协议制作出来的接口，让我们进行适配，其实这个技术已经淘汰了，不过对方是erp也不可能因为你而改写什么对吧，这里我们就分析一下怎么解决这个问题。</p>\n</blockquote>\n<h2 id=\"SOAP（Simple-Object-Access-Protocol）-简单对象访问协议\"><a href=\"#SOAP（Simple-Object-Access-Protocol）-简单对象访问协议\" class=\"headerlink\" title=\"SOAP（Simple Object Access Protocol） 简单对象访问协议\"></a>SOAP（Simple Object Access Protocol） 简单对象访问协议</h2><blockquote>\n<p>SOAP是基于XML的建议协议，可使用应用程序的HTTP之上进行信息交换或简单地说：SOAP使用用于访问网络服务的协议。</p>\n</blockquote>\n<ol>\n<li>什么是SOAP？</li>\n</ol>\n<ul>\n<li>SOAP 指__简易对象访问协议__</li>\n<li>SOAP 是一种__通信协议__</li>\n<li>SOAP 用于__应用程序之间__的通信</li>\n<li>SOAP 是一种__发送消息__的格式</li>\n<li>SOAP 被设计用来__通过因特网__进行通信</li>\n<li>SOAP <strong>独立于平台</strong></li>\n<li>SOAP <strong>独立于语言</strong></li>\n<li>SOAP <strong>基于XML</strong></li>\n<li>SOAP <strong>很简单并可扩展</strong></li>\n<li>SOAP 允许你__绕过防火墙__</li>\n<li>SOAP 将被作为__W3C标准__来发展</li>\n</ul>\n<ol start=\"2\">\n<li><img src=\"http://img.yuekang.org.cn/blog/images/2017041701.gif\" alt=\"SOAP\"></li>\n</ol>\n<p>6.约定的交互格式交互格式</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soapenv:Envelope</span> <span class=\"attr\">xmlns:soapenv</span>=<span class=\"string\">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class=\"attr\">xmlns:sen</span>=<span class=\"string\">&quot;http://pi.want-want.com/ZRFCARW_1/Sender_Syn&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Header</span>/&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">sen:MT_ZRFCARW01_Req</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!--Optional:--&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">IM_OBJID</span>&gt;</span>&#123;json数据&#125;<span class=\"tag\">&lt;/<span class=\"name\">IM_OBJID</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">sen:MT_ZRFCARW01_Req</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soapenv:Envelope</span> <span class=\"attr\">xmlns:soapenv</span>=<span class=\"string\">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class=\"attr\">xmlns:sen</span>=<span class=\"string\">&quot;http://pi.want-want.com/ZRFCARW_2/Sender_Syn&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Header</span>/&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">sen:MT_ZRFCARW02_Req</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!--Optional:--&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">IM_JSON</span>&gt;</span>&#123;json数据&#125;<span class=\"tag\">&lt;/<span class=\"name\">IM_JSON</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">sen:MT_ZRFCARW02_Req</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">soapenv:Envelope</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ol start=\"7\">\n<li>鉴权方式<br>– BaseAuthor验证方式</li>\n</ol>\n<hr>\n<h5 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h5><ol>\n<li>通过对方提供wsdl文档文件，使用soapUI软件进行测试解析</li>\n</ol>\n<ul>\n<li>soapUI工具图：</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042101.png\" alt=\"soapUI工具图\"></p>\n<blockquote>\n<p>当我们使用这个工具跑通接口后，这个时候还没有完成我们还必须要使用一个工具就是postman这个接口测试工具，有人可能要问了，为啥用soapui这个工具呢？答案是：交互数据接口，我们需要读取wsdl文件啊，才能知道交互的数据结构呢。</p>\n</blockquote>\n<ol start=\"2\">\n<li>使用postman软件进行接口的再次测试。</li>\n</ol>\n<ul>\n<li>从soapUI中获取相关信息进行解析使用postman进行测试</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042103.jpg\" alt=\"测试图1\"></p>\n<ul>\n<li>填入交互数据</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042104.jpg\" alt=\"交互数据图\"></p>\n<ul>\n<li>返回的结果图</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042102.jpg\" alt=\"返回结果图\"></p>\n<blockquote>\n<p>我们获取到了正式的数据，我们还需要提取xml中的json数据，我得解决方案是通过正则匹配的形式提取json，还有另一种办法，因为数据的格式还是比较简单的，也可以采取替换的原则，去掉json的前后无用的xml标签数据</p>\n</blockquote>\n<hr>\n<h6 id=\"一下是我写的通信代码\"><a href=\"#一下是我写的通信代码\" class=\"headerlink\" title=\"一下是我写的通信代码\"></a>一下是我写的通信代码</h6><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ApiNetManager</span>(<span class=\"params\"><span class=\"variable\">$json</span> = <span class=\"literal\">null</span>, <span class=\"variable\">$isID</span> = <span class=\"literal\">true</span></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根地址</span></span><br><span class=\"line\">    <span class=\"variable\">$baseUrl</span> = <span class=\"string\">&#x27;url&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$port</span> = <span class=\"string\">&#x27;port&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$username</span> = <span class=\"string\">&#x27;username&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$password</span> = <span class=\"string\">&#x27;password&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//统一消息返回格式</span></span><br><span class=\"line\">    <span class=\"variable\">$info</span> = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">        <span class=\"string\">&#x27;code&#x27;</span> =&gt; <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;message&#x27;</span> =&gt; <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;data&#x27;</span> =&gt; <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"comment\">//验证json的正确性</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">is_null</span>(<span class=\"title function_ invoke__\">json_decode</span>(<span class=\"variable\">$json</span>))) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//构建网络请求</span></span><br><span class=\"line\">    <span class=\"variable\">$curl</span> = <span class=\"title function_ invoke__\">curl_init</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$isID</span>) &#123;<span class=\"comment\">//验证课程ID</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">curl_setopt_array</span>(<span class=\"variable\">$curl</span>, <span class=\"keyword\">array</span>(</span><br><span class=\"line\">            CURLOPT_PORT =&gt; <span class=\"variable\">$port</span>,</span><br><span class=\"line\">            CURLOPT_URL =&gt; <span class=\"variable\">$baseUrl</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$port</span> . <span class=\"string\">&quot;/XISOAPAdapter/MessageServlet?senderParty=&amp;senderService=BC_OEXAM&amp;receiverParty=&amp;receiverService=&amp;interface=SI_ZRFCARW01_Out_Syn&amp;interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_1%2FSender_Syn&quot;</span>,</span><br><span class=\"line\">            CURLOPT_RETURNTRANSFER =&gt; <span class=\"literal\">true</span>,</span><br><span class=\"line\">            CURLOPT_ENCODING =&gt; <span class=\"string\">&quot;utf8&quot;</span>,</span><br><span class=\"line\">            CURLOPT_MAXREDIRS =&gt; <span class=\"number\">10</span>,</span><br><span class=\"line\">            CURLOPT_TIMEOUT =&gt; <span class=\"number\">30</span>,</span><br><span class=\"line\">            CURLOPT_HTTP_VERSION =&gt; CURL_HTTP_VERSION_1_1,</span><br><span class=\"line\">            CURLOPT_CUSTOMREQUEST =&gt; <span class=\"string\">&quot;POST&quot;</span>,</span><br><span class=\"line\">            CURLOPT_POSTFIELDS =&gt; <span class=\"string\">&quot;&lt;soapenv:Envelope xmlns:soapenv=\\&quot;http://schemas.xmlsoap.org/soap/envelope/\\&quot; xmlns:sen=\\&quot;http://pi.want-want.com/ZRFCARW_1/Sender_Syn\\&quot;&gt;&lt;soapenv:Header/&gt;&lt;soapenv:Body&gt;&lt;sen:MT_ZRFCARW01_Req&gt;&lt;IM_OBJID&gt;<span class=\"subst\">&#123;$json&#125;</span>&lt;/IM_OBJID&gt;&lt;/sen:MT_ZRFCARW01_Req&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_HTTPHEADER =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;authorization: Basic &quot;</span> . <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$password</span>),</span><br><span class=\"line\">                <span class=\"string\">&quot;cache-control: no-cache&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;content-type: application/xml&quot;</span>,</span><br><span class=\"line\">            ),</span><br><span class=\"line\">        ));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//回传考试成绩接口</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">curl_setopt_array</span>(<span class=\"variable\">$curl</span>, <span class=\"keyword\">array</span>(</span><br><span class=\"line\">            CURLOPT_PORT =&gt; <span class=\"string\">&quot;50000&quot;</span>,</span><br><span class=\"line\">            CURLOPT_URL =&gt; <span class=\"variable\">$baseUrl</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$port</span> . <span class=\"string\">&quot;/XISOAPAdapter/MessageServlet?senderParty=&amp;senderService=BC_OEXAM&amp;receiverParty=&amp;receiverService=&amp;interface=SI_ZRFCARW02_Out_Syn&amp;interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_2%2FSender_Syn&quot;</span>,</span><br><span class=\"line\">            CURLOPT_RETURNTRANSFER =&gt; <span class=\"literal\">true</span>,</span><br><span class=\"line\">            CURLOPT_ENCODING =&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_MAXREDIRS =&gt; <span class=\"number\">10</span>,</span><br><span class=\"line\">            CURLOPT_TIMEOUT =&gt; <span class=\"number\">30</span>,</span><br><span class=\"line\">            CURLOPT_HTTP_VERSION =&gt; CURL_HTTP_VERSION_1_1,</span><br><span class=\"line\">            CURLOPT_CUSTOMREQUEST =&gt; <span class=\"string\">&quot;POST&quot;</span>,</span><br><span class=\"line\">            CURLOPT_POSTFIELDS =&gt; <span class=\"string\">&quot;&lt;soapenv:Envelope xmlns:soapenv=\\&quot;http://schemas.xmlsoap.org/soap/envelope/\\&quot; xmlns:sen=\\&quot;http://pi.want-want.com/ZRFCARW_2/Sender_Syn\\&quot;&gt;&lt;soapenv:Header/&gt;&lt;soapenv:Body&gt;&lt;sen:MT_ZRFCARW02_Req&gt;&lt;IM_JSON&gt;<span class=\"subst\">&#123;$json&#125;</span>&lt;/IM_JSON&gt;&lt;/sen:MT_ZRFCARW02_Req&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_HTTPHEADER =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;authorization: Basic &quot;</span> . <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$password</span>),</span><br><span class=\"line\">                <span class=\"string\">&quot;cache-control: no-cache&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;content-type: application/xml&quot;</span>,</span><br><span class=\"line\">            ),</span><br><span class=\"line\">        ));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//执行网络请求</span></span><br><span class=\"line\">    <span class=\"variable\">$response</span> = <span class=\"title function_ invoke__\">curl_exec</span>(<span class=\"variable\">$curl</span>);</span><br><span class=\"line\">    <span class=\"variable\">$err</span> = <span class=\"title function_ invoke__\">curl_error</span>(<span class=\"variable\">$curl</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$err</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">500</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;服务器异常，请稍后再试&#x27;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">strstr</span>(<span class=\"variable\">$response</span>, <span class=\"string\">&#x27;&lt;title&gt;Error Report&lt;/title&gt;&#x27;</span>)) &#123;<span class=\"comment\">//请求成功权限没有通过</span></span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">302</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;服务器请求权限未通过请联系管理员!&#x27;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//请求并权限通过</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$isID</span>) &#123;<span class=\"comment\">//验证课程id的json查找</span></span><br><span class=\"line\">            <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"string\">&quot;/&#123;.+&#125;/&quot;</span>, <span class=\"variable\">$response</span>, <span class=\"variable\">$match</span>);<span class=\"comment\">//查找json</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//考试成绩回传的json查找</span></span><br><span class=\"line\">            <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"string\">&#x27;/\\[&#123;.*?\\&#125;]/is&#x27;</span>, <span class=\"variable\">$response</span>, <span class=\"variable\">$match</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$jsonArr</span> = <span class=\"title function_ invoke__\">json_decode</span>(<span class=\"variable\">$match</span>[<span class=\"number\">0</span>], <span class=\"literal\">true</span>);<span class=\"comment\">//解析json</span></span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">200</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;请求成功，成功返回数据&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;data&#x27;</span>] = <span class=\"variable\">$jsonArr</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] == <span class=\"number\">0</span> ? <span class=\"literal\">false</span> : <span class=\"variable\">$info</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>至此我们完成了数据的代码的填写，相关具体测试我就不多说了，这里我加入了标准的接口返回形式，一边后续的代码可以更加精确地判断问题出在哪里，好了就到这里，谢谢大家的观看。</p>\n</blockquote>\n","excerpt":"","more":"<blockquote>\n<p>博主工作一周了，上一周里遇到了一个难题，就是对方提供的是SOAP协议制作出来的接口，让我们进行适配，其实这个技术已经淘汰了，不过对方是erp也不可能因为你而改写什么对吧，这里我们就分析一下怎么解决这个问题。</p>\n</blockquote>\n<h2 id=\"SOAP（Simple-Object-Access-Protocol）-简单对象访问协议\"><a href=\"#SOAP（Simple-Object-Access-Protocol）-简单对象访问协议\" class=\"headerlink\" title=\"SOAP（Simple Object Access Protocol） 简单对象访问协议\"></a>SOAP（Simple Object Access Protocol） 简单对象访问协议</h2><blockquote>\n<p>SOAP是基于XML的建议协议，可使用应用程序的HTTP之上进行信息交换或简单地说：SOAP使用用于访问网络服务的协议。</p>\n</blockquote>\n<ol>\n<li>什么是SOAP？</li>\n</ol>\n<ul>\n<li>SOAP 指__简易对象访问协议__</li>\n<li>SOAP 是一种__通信协议__</li>\n<li>SOAP 用于__应用程序之间__的通信</li>\n<li>SOAP 是一种__发送消息__的格式</li>\n<li>SOAP 被设计用来__通过因特网__进行通信</li>\n<li>SOAP <strong>独立于平台</strong></li>\n<li>SOAP <strong>独立于语言</strong></li>\n<li>SOAP <strong>基于XML</strong></li>\n<li>SOAP <strong>很简单并可扩展</strong></li>\n<li>SOAP 允许你__绕过防火墙__</li>\n<li>SOAP 将被作为__W3C标准__来发展</li>\n</ul>\n<ol start=\"2\">\n<li><img src=\"http://img.yuekang.org.cn/blog/images/2017041701.gif\" alt=\"SOAP\"></li>\n</ol>\n<p>6.约定的交互格式交互格式</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soapenv:Envelope</span> <span class=\"attr\">xmlns:soapenv</span>=<span class=\"string\">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class=\"attr\">xmlns:sen</span>=<span class=\"string\">&quot;http://pi.want-want.com/ZRFCARW_1/Sender_Syn&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Header</span>/&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">sen:MT_ZRFCARW01_Req</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!--Optional:--&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">IM_OBJID</span>&gt;</span>&#123;json数据&#125;<span class=\"tag\">&lt;/<span class=\"name\">IM_OBJID</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">sen:MT_ZRFCARW01_Req</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soapenv:Envelope</span> <span class=\"attr\">xmlns:soapenv</span>=<span class=\"string\">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class=\"attr\">xmlns:sen</span>=<span class=\"string\">&quot;http://pi.want-want.com/ZRFCARW_2/Sender_Syn&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Header</span>/&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">sen:MT_ZRFCARW02_Req</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!--Optional:--&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">IM_JSON</span>&gt;</span>&#123;json数据&#125;<span class=\"tag\">&lt;/<span class=\"name\">IM_JSON</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">sen:MT_ZRFCARW02_Req</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">soapenv:Body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">soapenv:Envelope</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ol start=\"7\">\n<li>鉴权方式<br>– BaseAuthor验证方式</li>\n</ol>\n<hr>\n<h5 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h5><ol>\n<li>通过对方提供wsdl文档文件，使用soapUI软件进行测试解析</li>\n</ol>\n<ul>\n<li>soapUI工具图：</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042101.png\" alt=\"soapUI工具图\"></p>\n<blockquote>\n<p>当我们使用这个工具跑通接口后，这个时候还没有完成我们还必须要使用一个工具就是postman这个接口测试工具，有人可能要问了，为啥用soapui这个工具呢？答案是：交互数据接口，我们需要读取wsdl文件啊，才能知道交互的数据结构呢。</p>\n</blockquote>\n<ol start=\"2\">\n<li>使用postman软件进行接口的再次测试。</li>\n</ol>\n<ul>\n<li>从soapUI中获取相关信息进行解析使用postman进行测试</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042103.jpg\" alt=\"测试图1\"></p>\n<ul>\n<li>填入交互数据</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042104.jpg\" alt=\"交互数据图\"></p>\n<ul>\n<li>返回的结果图</li>\n</ul>\n<p><img src=\"http://img.yuekang.org.cn/blog/images/2017042102.jpg\" alt=\"返回结果图\"></p>\n<blockquote>\n<p>我们获取到了正式的数据，我们还需要提取xml中的json数据，我得解决方案是通过正则匹配的形式提取json，还有另一种办法，因为数据的格式还是比较简单的，也可以采取替换的原则，去掉json的前后无用的xml标签数据</p>\n</blockquote>\n<hr>\n<h6 id=\"一下是我写的通信代码\"><a href=\"#一下是我写的通信代码\" class=\"headerlink\" title=\"一下是我写的通信代码\"></a>一下是我写的通信代码</h6><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ApiNetManager</span>(<span class=\"params\"><span class=\"variable\">$json</span> = <span class=\"literal\">null</span>, <span class=\"variable\">$isID</span> = <span class=\"literal\">true</span></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根地址</span></span><br><span class=\"line\">    <span class=\"variable\">$baseUrl</span> = <span class=\"string\">&#x27;url&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$port</span> = <span class=\"string\">&#x27;port&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$username</span> = <span class=\"string\">&#x27;username&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$password</span> = <span class=\"string\">&#x27;password&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\">//统一消息返回格式</span></span><br><span class=\"line\">    <span class=\"variable\">$info</span> = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">        <span class=\"string\">&#x27;code&#x27;</span> =&gt; <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;message&#x27;</span> =&gt; <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;data&#x27;</span> =&gt; <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"comment\">//验证json的正确性</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">is_null</span>(<span class=\"title function_ invoke__\">json_decode</span>(<span class=\"variable\">$json</span>))) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//构建网络请求</span></span><br><span class=\"line\">    <span class=\"variable\">$curl</span> = <span class=\"title function_ invoke__\">curl_init</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$isID</span>) &#123;<span class=\"comment\">//验证课程ID</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">curl_setopt_array</span>(<span class=\"variable\">$curl</span>, <span class=\"keyword\">array</span>(</span><br><span class=\"line\">            CURLOPT_PORT =&gt; <span class=\"variable\">$port</span>,</span><br><span class=\"line\">            CURLOPT_URL =&gt; <span class=\"variable\">$baseUrl</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$port</span> . <span class=\"string\">&quot;/XISOAPAdapter/MessageServlet?senderParty=&amp;senderService=BC_OEXAM&amp;receiverParty=&amp;receiverService=&amp;interface=SI_ZRFCARW01_Out_Syn&amp;interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_1%2FSender_Syn&quot;</span>,</span><br><span class=\"line\">            CURLOPT_RETURNTRANSFER =&gt; <span class=\"literal\">true</span>,</span><br><span class=\"line\">            CURLOPT_ENCODING =&gt; <span class=\"string\">&quot;utf8&quot;</span>,</span><br><span class=\"line\">            CURLOPT_MAXREDIRS =&gt; <span class=\"number\">10</span>,</span><br><span class=\"line\">            CURLOPT_TIMEOUT =&gt; <span class=\"number\">30</span>,</span><br><span class=\"line\">            CURLOPT_HTTP_VERSION =&gt; CURL_HTTP_VERSION_1_1,</span><br><span class=\"line\">            CURLOPT_CUSTOMREQUEST =&gt; <span class=\"string\">&quot;POST&quot;</span>,</span><br><span class=\"line\">            CURLOPT_POSTFIELDS =&gt; <span class=\"string\">&quot;&lt;soapenv:Envelope xmlns:soapenv=\\&quot;http://schemas.xmlsoap.org/soap/envelope/\\&quot; xmlns:sen=\\&quot;http://pi.want-want.com/ZRFCARW_1/Sender_Syn\\&quot;&gt;&lt;soapenv:Header/&gt;&lt;soapenv:Body&gt;&lt;sen:MT_ZRFCARW01_Req&gt;&lt;IM_OBJID&gt;<span class=\"subst\">&#123;$json&#125;</span>&lt;/IM_OBJID&gt;&lt;/sen:MT_ZRFCARW01_Req&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_HTTPHEADER =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;authorization: Basic &quot;</span> . <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$password</span>),</span><br><span class=\"line\">                <span class=\"string\">&quot;cache-control: no-cache&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;content-type: application/xml&quot;</span>,</span><br><span class=\"line\">            ),</span><br><span class=\"line\">        ));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//回传考试成绩接口</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">curl_setopt_array</span>(<span class=\"variable\">$curl</span>, <span class=\"keyword\">array</span>(</span><br><span class=\"line\">            CURLOPT_PORT =&gt; <span class=\"string\">&quot;50000&quot;</span>,</span><br><span class=\"line\">            CURLOPT_URL =&gt; <span class=\"variable\">$baseUrl</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$port</span> . <span class=\"string\">&quot;/XISOAPAdapter/MessageServlet?senderParty=&amp;senderService=BC_OEXAM&amp;receiverParty=&amp;receiverService=&amp;interface=SI_ZRFCARW02_Out_Syn&amp;interfaceNamespace=http%3A%2F%2Fpi.want-want.com%2FZRFCARW_2%2FSender_Syn&quot;</span>,</span><br><span class=\"line\">            CURLOPT_RETURNTRANSFER =&gt; <span class=\"literal\">true</span>,</span><br><span class=\"line\">            CURLOPT_ENCODING =&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_MAXREDIRS =&gt; <span class=\"number\">10</span>,</span><br><span class=\"line\">            CURLOPT_TIMEOUT =&gt; <span class=\"number\">30</span>,</span><br><span class=\"line\">            CURLOPT_HTTP_VERSION =&gt; CURL_HTTP_VERSION_1_1,</span><br><span class=\"line\">            CURLOPT_CUSTOMREQUEST =&gt; <span class=\"string\">&quot;POST&quot;</span>,</span><br><span class=\"line\">            CURLOPT_POSTFIELDS =&gt; <span class=\"string\">&quot;&lt;soapenv:Envelope xmlns:soapenv=\\&quot;http://schemas.xmlsoap.org/soap/envelope/\\&quot; xmlns:sen=\\&quot;http://pi.want-want.com/ZRFCARW_2/Sender_Syn\\&quot;&gt;&lt;soapenv:Header/&gt;&lt;soapenv:Body&gt;&lt;sen:MT_ZRFCARW02_Req&gt;&lt;IM_JSON&gt;<span class=\"subst\">&#123;$json&#125;</span>&lt;/IM_JSON&gt;&lt;/sen:MT_ZRFCARW02_Req&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;&quot;</span>,</span><br><span class=\"line\">            CURLOPT_HTTPHEADER =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;authorization: Basic &quot;</span> . <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span> . <span class=\"string\">&#x27;:&#x27;</span> . <span class=\"variable\">$password</span>),</span><br><span class=\"line\">                <span class=\"string\">&quot;cache-control: no-cache&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;content-type: application/xml&quot;</span>,</span><br><span class=\"line\">            ),</span><br><span class=\"line\">        ));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//执行网络请求</span></span><br><span class=\"line\">    <span class=\"variable\">$response</span> = <span class=\"title function_ invoke__\">curl_exec</span>(<span class=\"variable\">$curl</span>);</span><br><span class=\"line\">    <span class=\"variable\">$err</span> = <span class=\"title function_ invoke__\">curl_error</span>(<span class=\"variable\">$curl</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$err</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">500</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;服务器异常，请稍后再试&#x27;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">strstr</span>(<span class=\"variable\">$response</span>, <span class=\"string\">&#x27;&lt;title&gt;Error Report&lt;/title&gt;&#x27;</span>)) &#123;<span class=\"comment\">//请求成功权限没有通过</span></span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">302</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;服务器请求权限未通过请联系管理员!&#x27;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//请求并权限通过</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$isID</span>) &#123;<span class=\"comment\">//验证课程id的json查找</span></span><br><span class=\"line\">            <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"string\">&quot;/&#123;.+&#125;/&quot;</span>, <span class=\"variable\">$response</span>, <span class=\"variable\">$match</span>);<span class=\"comment\">//查找json</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">//考试成绩回传的json查找</span></span><br><span class=\"line\">            <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"string\">&#x27;/\\[&#123;.*?\\&#125;]/is&#x27;</span>, <span class=\"variable\">$response</span>, <span class=\"variable\">$match</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$jsonArr</span> = <span class=\"title function_ invoke__\">json_decode</span>(<span class=\"variable\">$match</span>[<span class=\"number\">0</span>], <span class=\"literal\">true</span>);<span class=\"comment\">//解析json</span></span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] = <span class=\"number\">200</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;message&#x27;</span>] = <span class=\"string\">&#x27;请求成功，成功返回数据&#x27;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;data&#x27;</span>] = <span class=\"variable\">$jsonArr</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable\">$info</span>[<span class=\"string\">&#x27;code&#x27;</span>] == <span class=\"number\">0</span> ? <span class=\"literal\">false</span> : <span class=\"variable\">$info</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>至此我们完成了数据的代码的填写，相关具体测试我就不多说了，这里我加入了标准的接口返回形式，一边后续的代码可以更加精确地判断问题出在哪里，好了就到这里，谢谢大家的观看。</p>\n</blockquote>\n","path":"2017/04/17/2017-04-17-实现SOAP接口得适配/","permalink":"https://yuekang.org.cn/2017/04/17/2017-04-17-%E5%AE%9E%E7%8E%B0SOAP%E6%8E%A5%E5%8F%A3%E5%BE%97%E9%80%82%E9%85%8D/","tags":[{"name":"PHP","_id":"cm0w4eg19001fetsnhjecb6wt","slug":"PHP","path":"tags/PHP/","permalink":"https://yuekang.org.cn/tags/PHP/","length":15}],"categories":[],"prev":{"title":"学习Laravel(Day 1)","date":"2017-05-10T06:58:14.000Z","slug":"2017-05-10-学习Laravel-Day-1","published":true,"updated":"2024-09-11T07:46:20.601Z","_id":"cm0xkpfxo00013jsnhs7h77sz","layout":"post","photos":[],"excerpt":"","path":"2017/05/10/2017-05-10-学习Laravel-Day-1/","permalink":"https://yuekang.org.cn/2017/05/10/2017-05-10-%E5%AD%A6%E4%B9%A0Laravel-Day-1/","__post":true},"next":{"title":"给定路径统计当前以及子目录文件个数","date":"2017-03-30T12:05:39.000Z","slug":"2017-03-30-给定路径统计当前以及子目录文件个数","published":true,"updated":"2024-09-08T06:15:22.962Z","_id":"cm0w4eg0v000eetsn0x710pbd","layout":"post","photos":[],"excerpt":"","path":"2017/03/30/2017-03-30-给定路径统计当前以及子目录文件个数/","permalink":"https://yuekang.org.cn/2017/03/30/2017-03-30-%E7%BB%99%E5%AE%9A%E8%B7%AF%E5%BE%84%E7%BB%9F%E8%AE%A1%E5%BD%93%E5%89%8D%E4%BB%A5%E5%8F%8A%E5%AD%90%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6%E4%B8%AA%E6%95%B0/","__post":true},"__post":true}